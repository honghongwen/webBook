<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Jenkins | 山雨光云小集</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="山雨光云小集">
    
    <link rel="preload" href="/assets/css/0.styles.5ab8ebd7.css" as="style"><link rel="preload" href="/assets/js/app.1211b944.js" as="script"><link rel="preload" href="/assets/js/2.d9cdd38b.js" as="script"><link rel="preload" href="/assets/js/10.8d543d8c.js" as="script"><link rel="prefetch" href="/assets/js/11.2cfcc750.js"><link rel="prefetch" href="/assets/js/12.54781427.js"><link rel="prefetch" href="/assets/js/13.f450e900.js"><link rel="prefetch" href="/assets/js/14.f76a28e8.js"><link rel="prefetch" href="/assets/js/15.fb7f9400.js"><link rel="prefetch" href="/assets/js/16.9234d627.js"><link rel="prefetch" href="/assets/js/17.e262864f.js"><link rel="prefetch" href="/assets/js/18.4e875c29.js"><link rel="prefetch" href="/assets/js/19.a995da09.js"><link rel="prefetch" href="/assets/js/20.adc26647.js"><link rel="prefetch" href="/assets/js/21.55c48e84.js"><link rel="prefetch" href="/assets/js/22.3f3a83d0.js"><link rel="prefetch" href="/assets/js/23.deed6bd2.js"><link rel="prefetch" href="/assets/js/24.746bbc50.js"><link rel="prefetch" href="/assets/js/25.2e425410.js"><link rel="prefetch" href="/assets/js/26.0c29c466.js"><link rel="prefetch" href="/assets/js/27.5e6bedfd.js"><link rel="prefetch" href="/assets/js/28.8e4a8ccc.js"><link rel="prefetch" href="/assets/js/29.020ccf97.js"><link rel="prefetch" href="/assets/js/3.7bd32064.js"><link rel="prefetch" href="/assets/js/30.43d740de.js"><link rel="prefetch" href="/assets/js/31.35476f65.js"><link rel="prefetch" href="/assets/js/32.20057b37.js"><link rel="prefetch" href="/assets/js/33.fd9470e1.js"><link rel="prefetch" href="/assets/js/34.01313131.js"><link rel="prefetch" href="/assets/js/35.45efba1c.js"><link rel="prefetch" href="/assets/js/36.74e309b1.js"><link rel="prefetch" href="/assets/js/37.e0900611.js"><link rel="prefetch" href="/assets/js/38.a0e0b9f1.js"><link rel="prefetch" href="/assets/js/39.5284a6de.js"><link rel="prefetch" href="/assets/js/4.642422bc.js"><link rel="prefetch" href="/assets/js/40.932439c4.js"><link rel="prefetch" href="/assets/js/41.ee7ac8cc.js"><link rel="prefetch" href="/assets/js/42.dc683951.js"><link rel="prefetch" href="/assets/js/43.c38eb04b.js"><link rel="prefetch" href="/assets/js/44.3bdc7170.js"><link rel="prefetch" href="/assets/js/45.fdd93da2.js"><link rel="prefetch" href="/assets/js/5.3bc68866.js"><link rel="prefetch" href="/assets/js/6.f8936891.js"><link rel="prefetch" href="/assets/js/7.6d48973a.js"><link rel="prefetch" href="/assets/js/8.1a64b73c.js"><link rel="prefetch" href="/assets/js/9.ff7216d2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5ab8ebd7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">山雨光云小集</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://shanyuguangyun.github.io/gitBook" target="_blank" rel="noopener noreferrer" class="nav-link external">
  基础知识
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://qms.shanyuguangyun.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  问卷网页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/shanyuguangyun/leetcode" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/shanyuguangyun" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://shanyuguangyun.github.io/gitBook" target="_blank" rel="noopener noreferrer" class="nav-link external">
  基础知识
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://qms.shanyuguangyun.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  问卷网页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/shanyuguangyun/leetcode" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/shanyuguangyun" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/front/vue.html" class="sidebar-link">Vue知识</a></li><li><a href="/front/nvm.html" class="sidebar-link">Nvm管理Node版本</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>后端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/backend/springboot.html" class="sidebar-link">SpringBoot</a></li><li><a href="/backend/threadpool.html" class="sidebar-link">Treadpool项目中应用</a></li><li><a href="/backend/logback.html" class="sidebar-link">LogBack日志配置</a></li><li><a href="/backend/easyexcel.html" class="sidebar-link">EasyExcel使用</a></li><li><a href="/backend/fdfs.html" class="sidebar-link">FDFS使用</a></li><li><a href="/backend/redis.html" class="sidebar-link">Redis学习</a></li><li><a href="/backend/hadoop.html" class="sidebar-link">Hadoop</a></li><li><a href="/backend/elkf.html" class="sidebar-link">ELK+Filebeat的搭建</a></li><li><a href="/backend/elasticsearch.html" class="sidebar-link">Elasticsearch</a></li><li><a href="/backend/canal.html" class="sidebar-link">Canal同步mysql到ES</a></li><li><a href="/backend/oraclecdc.html" class="sidebar-link">Oracle CDC调研比较</a></li><li><a href="/backend/flinkcdc.html" class="sidebar-link">Flink-CDC同步Oracle全量+增量数据</a></li><li><a href="/backend/kafka.html" class="sidebar-link">Kafka学习总结</a></li><li><a href="/backend/arthas.html" class="sidebar-link">Arthas</a></li><li><a href="/backend/intelij.html" class="sidebar-link">Intelij一些设置</a></li><li><a href="/backend/problem.html" class="sidebar-link">常遇到的问题</a></li><li><a href="/backend/ab.html" class="sidebar-link">ab性能测试</a></li><li><a href="/backend/499.html" class="sidebar-link">一次Nginx499状态码排查</a></li><li><a href="/backend/ssm.html" class="sidebar-link">SSM项目</a></li><li><a href="/backend/oracle.html" class="sidebar-link">Oracle</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>运维手册</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yunwei/vmware.html" class="sidebar-link">VMware</a></li><li><a href="/yunwei/nginx.html" class="sidebar-link">Nginx</a></li><li><a href="/yunwei/linux.html" class="sidebar-link">Linux</a></li><li><a href="/yunwei/vim.html" class="sidebar-link">Vim</a></li><li><a href="/yunwei/supervisor.html" class="sidebar-link">SuperVisor</a></li><li><a href="/yunwei/gitbook.html" class="sidebar-link">GitBook</a></li><li><a href="/yunwei/gitlab.html" class="sidebar-link">GitLab</a></li><li><a href="/yunwei/jenkins.html" aria-current="page" class="active sidebar-link">Jenkins</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/yunwei/jenkins.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/yunwei/jenkins.html#工作流程" class="sidebar-link">工作流程</a></li><li class="sidebar-sub-header"><a href="/yunwei/jenkins.html#配置步骤" class="sidebar-link">配置步骤</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/yunwei/jenkins.html#_1-步骤" class="sidebar-link">1. 步骤</a></li><li class="sidebar-sub-header"><a href="/yunwei/jenkins.html#_2-start-sh" class="sidebar-link">2. start.sh</a></li><li class="sidebar-sub-header"><a href="/yunwei/jenkins.html#_3-jenkins全局配置" class="sidebar-link">3.jenkins全局配置</a></li></ul></li><li class="sidebar-sub-header"><a href="/yunwei/jenkins.html#角色分配" class="sidebar-link">角色分配</a></li><li class="sidebar-sub-header"><a href="/yunwei/jenkins.html#使用webhook自动部署" class="sidebar-link">使用webhook自动部署</a></li><li class="sidebar-sub-header"><a href="/yunwei/jenkins.html#常用命令" class="sidebar-link">常用命令</a></li></ul></li><li><a href="/yunwei/redis.html" class="sidebar-link">Redis</a></li><li><a href="/yunwei/prometheus.html" class="sidebar-link">Prometheus</a></li><li><a href="/yunwei/rabbitmq.html" class="sidebar-link">RabbitMq</a></li><li><a href="/yunwei/wiki.html" class="sidebar-link">Confluence Wiki</a></li><li><a href="/yunwei/wakuang.html" class="sidebar-link">脚本攻击处理</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="jenkins"><a href="#jenkins" class="header-anchor">#</a> Jenkins</h1> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <p>Jenkins官网下载所需版本的war包即可<a href="https://jenkins.io/zh/download/" target="_blank" rel="noopener noreferrer">下载地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>(推荐下载LTS即长期支持版本问题会比较少)
或者查看<a href="https://pkg.jenkins.io/redhat-stable/" target="_blank" rel="noopener noreferrer">官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，使用wget等安装都可</p> <p>jenkins并未给启动命令，所以可以自己写一个脚本避免每次都用命令查找kill。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">pid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> jenkins.war <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">'grep'</span><span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $2}'</span><span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span><span class="token variable">`</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$1</span>&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;start&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$pid</span> <span class="token parameter variable">-gt</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">'jenkins is running...'</span>
    <span class="token keyword">else</span>
    <span class="token function">java</span> <span class="token parameter variable">-jar</span> jenkins.war <span class="token parameter variable">--httpPort</span><span class="token operator">=</span><span class="token number">8888</span> <span class="token operator">&gt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
        <span class="token keyword">fi</span>
<span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$1</span>&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;stop&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        <span class="token builtin class-name">exec</span> <span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> jenkins <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $2}'</span><span class="token operator">|</span> <span class="token function">xargs</span> <span class="token function">kill</span> <span class="token parameter variable">-9</span>
    <span class="token builtin class-name">echo</span> <span class="token string">'jenkins is stop..'</span>
<span class="token keyword">else</span>
        <span class="token builtin class-name">echo</span> <span class="token string">&quot;Please input like this:&quot;</span>./jenkins.sh start<span class="token string">&quot; or &quot;</span>./jenkins stop<span class="token string">&quot;&quot;</span>
<span class="token keyword">fi</span>
</code></pre></div><p>使用方式</p> <div class="language-shell extra-class"><pre class="language-shell"><code>./jenkins.sh stop
./jenkins.sh start
</code></pre></div><h2 id="工作流程"><a href="#工作流程" class="header-anchor">#</a> 工作流程</h2> <ol><li>拉取gitlab上代码(可指定分支，使用插件)</li> <li>本地shell构建获取jar包或者dist文件夹</li> <li>ssh发送到远程服务器(可先本地打成zip文件)</li> <li>在远程服务器上执行shell,运行项目</li></ol> <h2 id="配置步骤"><a href="#配置步骤" class="header-anchor">#</a> 配置步骤</h2> <h3 id="_1-步骤"><a href="#_1-步骤" class="header-anchor">#</a> 1. 步骤</h3> <ol><li>新建任务,选自由风格，输入名称</li> <li>填入描述，选中丢弃旧的构建，天数和最大个数都填1</li> <li>选中参数化构建过程，选择git参数，名称填checkBranch，描述填选择要部署的分支或tag，参数类型选择分支或标签，默认值填origin/master</li> <li>源码管理-&gt;Repository URL填项目地址，选Credentials。Branches to build指定分支填$checkBranch。源码库浏览器选gitlab,version填10.0</li> <li>构建，分前后端
<ol><li>后端项目
<ol><li>选调用顶层maven目标</li> <li>选maven版本</li> <li>目标填clean install -Dmaven.test.skip=true</li> <li>增加构建步骤，选Execute shell script on remote host using ssh执行shell</li> <li>ssh site选jenkins服务器</li> <li>command填,将jar包打成zip包(可选),因为jar本身就是压缩包<div class="language-shell extra-class"><pre class="language-shell"><code> <span class="token builtin class-name">cd</span> /root/.jenkins/workspace/test_demoProject/target
 <span class="token function">zip</span> <span class="token parameter variable">-q</span> <span class="token parameter variable">-r</span> demoProject.zip ./demoProject-1.0.0.jar
</code></pre></div></li></ol></li> <li>前端项目
<ol><li>选执行shell，直接用shell打包即可，后端其实也可以如此操作</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code> <span class="token builtin class-name">cd</span> /root/.jenkins/workspace/test_demoProject
 /usr/local/node-v13.14.0-linux-x64/bin/npm <span class="token function">install</span>
 /usr/local/node-v13.14.0-linux-x64/bin/npm run build
 <span class="token builtin class-name">echo</span> <span class="token string">'build success, start move directory'</span>
 <span class="token function">zip</span> <span class="token parameter variable">-q</span> <span class="token parameter variable">-r</span> demoProject.zip ./dist/
 <span class="token builtin class-name">echo</span> <span class="token string">'zip success'</span>
</code></pre></div><ol start="2"><li>同时前端项目的下一步操作中Source files直接填demoProject.zip, Remove prefix为空，remote directory填 /demoProject</li> <li>前端的下一步中Exec command不同，将文件解压到nginx的html目录即可，对应的nginx的root也要配置到demoProject文件夹下</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code> <span class="token builtin class-name">cd</span> /usr/local/nginx
 <span class="token function">rm</span> <span class="token parameter variable">-rf</span> ./demoProject
 <span class="token function">unzip</span> <span class="token parameter variable">-o</span> <span class="token parameter variable">-d</span> /usr/local/nginx /opt/jenkins/demoProject/demoProject.zip 
 <span class="token function">mv</span> dist/ demoProject/
 <span class="token builtin class-name">cd</span> /opt/jenkins/demoProject
 <span class="token function">mv</span> demoProject.zip ./version
 <span class="token builtin class-name">cd</span> version/
 <span class="token function">mv</span> demoProject.zip ./demoProject-<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d-%H%M<span class="token variable">)</span></span>.zip 
</code></pre></div></li></ol></li> <li>构建后操作选Send build artifacts over SSH
<ol><li>SSH Publishers
<ol><li>SSH Server选要部署到的机器</li> <li>Transfers Source files填 target/demoProject.zip, Remove Prefix填target/, Remote Directory填 /demoProject (发送到运行服务器的指定文件夹) Exec command填，意思是进入运行服务器该目录,删掉上一个jar包,将发送过来的zip包解压，然后备份到version目录下，执行启动程序脚本</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>  <span class="token builtin class-name">cd</span> /opt/jenkins/demoProject
  <span class="token function">rm</span> <span class="token parameter variable">-rf</span> demoProject-1.0.0.jar
  <span class="token function">unzip</span> <span class="token parameter variable">-o</span> <span class="token parameter variable">-d</span> /opt/jenkins/demoProject /opt/jenkins/demoProject/demoProject.zip
  <span class="token function">mv</span> demoProject.zip ./version/demoProject-<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d-%H%M<span class="token variable">)</span></span>.zip
  ./start.sh
</code></pre></div></li></ol></li> <li>增加构建后操作Delete workspace when build is done,不然服务器磁盘很快就会满</li></ol> <h3 id="_2-start-sh"><a href="#_2-start-sh" class="header-anchor">#</a> 2. start.sh</h3> <p>由于我的后端程序都托管给了supervisor,所以我的脚本如下。要注意的是java的jar包一定要指定好为1.0.0版本。约定好配置
关于supervisor的配置，请看我另一篇文章<a href="/yunwei/supervisor.html">supervisor</a></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">JAR_PATH</span><span class="token operator">=</span><span class="token string">'/opt/jenkins/demoProject'</span>

<span class="token assign-left variable">JAR_NAME</span><span class="token operator">=</span>demoProject-1.0.0.jar

<span class="token builtin class-name">cd</span> <span class="token variable">${JAR_PATH}</span>

<span class="token assign-left variable">pid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> demoProject<span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">'grep'</span><span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'{print $2}'</span><span class="token variable">`</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token string">&quot;<span class="token variable">$pid</span>&quot;</span> <span class="token punctuation">]</span>
<span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">'Now Ready to restart demoProject application.'</span>
  supervisorctl restart demoProject
<span class="token keyword">else</span>
  <span class="token builtin class-name">echo</span> <span class="token string">'Dont found the demoProject application. now ready to start it'</span>
  supervisorctl start demoProject
<span class="token keyword">fi</span>
<span class="token builtin class-name">echo</span> <span class="token string">'Server started successfuly...'</span>
</code></pre></div><h3 id="_3-jenkins全局配置"><a href="#_3-jenkins全局配置" class="header-anchor">#</a> 3.jenkins全局配置</h3> <p>对于上诉操作，其中需要用到ssh和git插件、以及maven配置和gitlab的Credentials。这些都需在jenkins中提前配置好。
其中我的一些配置如下</p> <ul><li>全局工具配置
<ul><li>git配置 path to git executable为/usr/bin/git，这些其实有需要的就配，没需要直接用系统默认的就好，如jdk、git、maven等工具的配置</li></ul></li> <li>插件管理
<ul><li>Git plugin # 拉代码肯定需要</li> <li>Publish Over SSH # 通过ssh免密传输文件需要</li> <li>Maven Integration plugin # 构建maven项目</li> <li>Git Parameter # 针对不同分支进行部署需要</li> <li>Manage and Assign Roles # 给不同用户分配不同菜单视图需要</li></ul></li> <li>系统配置
<ul><li>Publish over SSH</li></ul></li> <li>Manage Credentials
<ul><li>这里的凭据自己按情况配置，如拉代码要gitlab的账号密码，直接使用username with password就ok</li></ul></li></ul> <p>publish over ssh配置如下，jenkins服务器生成ssh key，将id_rsa私钥放入jenkins的key中，同时path也填上。下方新增ssh server,填写名称和hostname.
填上用户名如root,以及远程目录，这个目录就是传输文件的父目录，如我的都是/opt/jenkins</p> <h2 id="角色分配"><a href="#角色分配" class="header-anchor">#</a> 角色分配</h2> <p>通常，公司内需分测试环境、灰度和生产环境，针对不同的人员，可能只允许其部署某个环境的代码。
比如给测试分配灰度、给开发分配测试环境、运维则是所有环境。</p> <p>而这种操作，我借助的是Manage and Assign Roles这个插件，同时因为针对每个环境，项目部署的地址不同。所以我采取的方案如下。</p> <p>针对同一个项目，采取test_和prod_开头新建任务，test_xxx代表这个项目的测试任务。prod_xxx代表这个项目的生产任务。同时新建视图prod、test将任务隔离开。
然后在角色管理中新增不同角色，使用正则匹配不同的项目，给不同成员分配不同的角色即可。需注意的是jenkins分为全局角色和子角色，需自行了解配置。</p> <p><img src="/assets/img/jenkins.bb28628f.png" alt="jenkins"> <img src="/assets/img/jenkins_prod.c1606871.png" alt="jenkins_prod"> <img src="/assets/img/jenkins_role.f57c0627.png" alt="jenkins_role"></p> <h2 id="使用webhook自动部署"><a href="#使用webhook自动部署" class="header-anchor">#</a> 使用webhook自动部署</h2> <p>在项目配置中，构建触发器，勾选Build when a change is pushed to GitLab. GitLab webhook URL:
同时高级-&gt;生成screct token。将URL和token拷贝。去到gitlab项目中,Settings-&gt;Integrations。将URL和token拷贝至其中，新增webhook.
这样一来，每次项目代码只要推到远程，就会触发自动部署。</p> <h2 id="常用命令"><a href="#常用命令" class="header-anchor">#</a> 常用命令</h2> <div class="language-shell extra-class"><pre class="language-shell"><code> // 启动进程
 <span class="token function">nohup</span> <span class="token function">java</span> <span class="token parameter variable">-jar</span> /usr/share/java/jenkins.war <span class="token parameter variable">--httpPort</span><span class="token operator">=</span><span class="token number">9897</span> <span class="token operator">&amp;</span>
 
 // 杀死进程
 <span class="token function">netstat</span> <span class="token parameter variable">-ntpl</span>
 <span class="token function">kill</span> <span class="token parameter variable">-9</span> pid
 
 // 或者
 <span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> jenkins.war <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $2}'</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token function">kill</span> <span class="token parameter variable">-9i</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/yunwei/gitlab.html" class="prev">
        GitLab
      </a></span> <span class="next"><a href="/yunwei/redis.html">
        Redis
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1211b944.js" defer></script><script src="/assets/js/2.d9cdd38b.js" defer></script><script src="/assets/js/10.8d543d8c.js" defer></script>
  </body>
</html>
