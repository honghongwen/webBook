(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{374:function(s,a,e){"use strict";e.r(a);var t=e(14),r=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"redis"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis"}},[s._v("#")]),s._v(" Redis")]),s._v(" "),a("h2",{attrs:{id:"安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[s._v("#")]),s._v(" 安装")]),s._v(" "),a("p",[s._v("从官网下载tar包  "),a("a",{attrs:{href:"https://redis.io/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://redis.io/"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("安装")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-zxvf")]),s._v(" ./redis-6.2.6.tar.gz "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-C")]),s._v(" /opt/module\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /home/software\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## then go to /usr/local/bin ll")]),s._v("\n")])])]),a("p",[s._v("配置")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /home/software/redis-6.2.6/\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" redis.conf\ndaemonize "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## change the redis-server start on background.")]),s._v("\nrequirepass xxxx "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## your password")]),s._v("\nlogfile /home/software/redis-6.2.6/log/redis.log\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## anyone can connect")]),s._v("\n")])])]),a("p",[s._v("启动")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("redis-server ./redis.conf "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## start server")]),s._v("\n\nredis-cli "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-h")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" password "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## start client")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" foo hello\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" get foo\n")])])]),a("h2",{attrs:{id:"主从搭建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#主从搭建"}},[s._v("#")]),s._v(" 主从搭建")]),s._v(" "),a("h2",{attrs:{id:"哨兵搭建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#哨兵搭建"}},[s._v("#")]),s._v(" 哨兵搭建")]),s._v(" "),a("h2",{attrs:{id:"集群搭建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#集群搭建"}},[s._v("#")]),s._v(" 集群搭建")]),s._v(" "),a("p",[s._v("集群至少需要三主三从，所以至少需要六台机器")]),s._v(" "),a("p",[s._v("创建文件夹")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /usr/local/redis-cluster/5001 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5002")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5006")]),s._v("\n")])])]),a("p",[s._v("将配置文件拷贝到目录中")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /opt/module/redis-2.6.2/redis.conf /usr/local/redis-cluster/5001\n")])])]),a("p",[s._v("修改配置文件")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("pidfile /var/run/redis_5001.pid\ndaemonize "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile /usr/local/redis-cluster/5001/redis.log\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /usr/local/redis-cluster/5001\nappendonly "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nappendfsync everysec\nport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5001")]),s._v("\n\ncluster-enabled "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\ncluster-config-file nodes-5001.conf\ncluster-node-timeout "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15000")]),s._v("\n")])])]),a("p",[s._v("同步几份配置文件到对应文件夹，并且替换5001->500x\n用对应配置文件启动redis-server")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("redis-server /usr/local/redis-cluster/500x/redis.conf\n")])])]),a("p",[s._v("使用集群搭建命令搭建集群 5.0之前使用ruby命令，5.0之后可以使用自带的命令")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("redis-cli "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" create ip:port ip2:port2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". --cluster-replicas n\n\nredis-cli "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" create \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".151.100:5001\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".151.100:5002 \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".151.100:5003 \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".151.100:5004 \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".151.100:5005 \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".151.100:5006 --cluster-replicas "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" password\n")])])]),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("redis-cli "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("help")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看帮助")]),s._v("\n")])])]),a("p",[s._v("16384个slots将会平分在几个主节点上\n集群模式登陆redis")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("redis-cli "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--pass")]),s._v(" password "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5001")]),s._v("\n")])])]),a("p",[s._v("!注意如果是虚拟机，磁盘是否够空间。")]),s._v(" "),a("p",[s._v("增加从节点\n分片")]),s._v(" "),a("blockquote",[a("p",[s._v("保障 Redis 高可用的 4 种手段：")])]),s._v(" "),a("blockquote",[a("p",[s._v("数据持久化保证了数据不丢失；")])]),s._v(" "),a("blockquote",[a("p",[s._v("Redis 主从让 Redis 从单机变成了多机。\n它有两种模式：主从模式和从从模式，但当主节点出现问题时，需要人工手动恢复系统；")])]),s._v(" "),a("blockquote",[a("p",[s._v("Redis 哨兵模式用来监控 Redis 主从模式，并提供了自动容灾恢复的功能。")])]),s._v(" "),a("blockquote",[a("p",[s._v("最后是 Redis 集群，除了可以提供主从和哨兵的功能之外，\n还提供了多个主从节点的集群功能，这样就可以把数据均匀的存储各个主机主节点上，\n实现了系统的横向扩展，大大提高了 Redis 的并发处理能力")])]),s._v(" "),a("h2",{attrs:{id:"常用命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常用命令"}},[s._v("#")]),s._v(" 常用命令")]),s._v(" "),a("p",[s._v("启动服务\nredis-server redis.conf ## 一般在安装目录")]),s._v(" "),a("p",[s._v("连接\nredis-cli -h host -p port -a password")]),s._v(" "),a("p",[s._v("查看慢查询")]),s._v(" "),a("p",[s._v("清空数据库\nflushall\nflushdb")]),s._v(" "),a("p",[s._v("停止服务\nshutdown")]),s._v(" "),a("h2",{attrs:{id:"数据结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据结构"}},[s._v("#")]),s._v(" 数据结构")]),s._v(" "),a("h3",{attrs:{id:"基本的五个"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基本的五个"}},[s._v("#")]),s._v(" 基本的五个")]),s._v(" "),a("ul",[a("li",[s._v("string")]),s._v(" "),a("li",[s._v("list")]),s._v(" "),a("li",[s._v("hash")]),s._v(" "),a("li",[s._v("set")]),s._v(" "),a("li",[s._v("sorted set")])]),s._v(" "),a("h3",{attrs:{id:"复杂的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#复杂的"}},[s._v("#")]),s._v(" 复杂的")]),s._v(" "),a("ul",[a("li",[s._v("SDS")])]),s._v(" "),a("p",[s._v("不同于c语言的字符串，redis定义了SDS构造体，因为c语言中要拿到字符串的长度，必须重头遍历这个字符串，直到末尾\\0。所以这个结构直接访问len就可以知道字符串长度，更节省了时间。\n杜绝了缓冲区溢出，c语言需要提前设置内存，如果将a字符串拼接，但是忘记重新设置长度，那它就会溢出到下个字符串的位置。设计了拼接api，会先检查长度，如果不够就先扩展。\n预分配空间\n减少了修改字符串长度频繁的分配空间操作，c语言需要这样的操作，但是SDS有空间预分配的操作。规则如下：\n1.如果分配后，SDS的长度将小于1m，那就会再设置和len想同长度的free字节。\n2.如果大于1m，那就加1m。")]),s._v(" "),a("p",[s._v("惰性释放\n字符串缩短时，不立马释放free空间，而是留着等以后，便于后续字符串又变长。\n当然也有对应api去释放这部分空间，不用担心内存浪费。")]),s._v(" "),a("div",{staticClass:"language-c extra-class"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sdshdr")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 已使用字节数量 5")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" len"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 未使用字节数量 0")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" free"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 用于保存字符串 \\0结尾 'R' 'e' 'd' 'i' 's' '\\0'")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("h2",{attrs:{id:"持久化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#持久化"}},[s._v("#")]),s._v(" 持久化")]),s._v(" "),a("ul",[a("li",[s._v("RDB\n可以通过SAVE命令或者BGSAVE命令（另起线程）保存dump.rdb文件\n文件保存的都是二进制的键值\n或者通过修改redis.conf文件")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("save "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 代表600秒内执行过一次命令")]),s._v("\n")])])]),a("ul",[a("li",[s._v("AOF")])]),s._v(" "),a("h2",{attrs:{id:"其他"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其他"}},[s._v("#")]),s._v(" 其他")])])}),[],!1,null,null,null);a.default=r.exports}}]);