<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Canal同步mysql到ES | 山雨光云小集</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="山雨光云小集">
    
    <link rel="preload" href="/assets/css/0.styles.5ab8ebd7.css" as="style"><link rel="preload" href="/assets/js/app.1211b944.js" as="script"><link rel="preload" href="/assets/js/2.d9cdd38b.js" as="script"><link rel="preload" href="/assets/js/7.6d48973a.js" as="script"><link rel="prefetch" href="/assets/js/10.8d543d8c.js"><link rel="prefetch" href="/assets/js/11.2cfcc750.js"><link rel="prefetch" href="/assets/js/12.54781427.js"><link rel="prefetch" href="/assets/js/13.f450e900.js"><link rel="prefetch" href="/assets/js/14.f76a28e8.js"><link rel="prefetch" href="/assets/js/15.fb7f9400.js"><link rel="prefetch" href="/assets/js/16.9234d627.js"><link rel="prefetch" href="/assets/js/17.e262864f.js"><link rel="prefetch" href="/assets/js/18.4e875c29.js"><link rel="prefetch" href="/assets/js/19.a995da09.js"><link rel="prefetch" href="/assets/js/20.adc26647.js"><link rel="prefetch" href="/assets/js/21.55c48e84.js"><link rel="prefetch" href="/assets/js/22.3f3a83d0.js"><link rel="prefetch" href="/assets/js/23.deed6bd2.js"><link rel="prefetch" href="/assets/js/24.746bbc50.js"><link rel="prefetch" href="/assets/js/25.2e425410.js"><link rel="prefetch" href="/assets/js/26.0c29c466.js"><link rel="prefetch" href="/assets/js/27.5e6bedfd.js"><link rel="prefetch" href="/assets/js/28.8e4a8ccc.js"><link rel="prefetch" href="/assets/js/29.020ccf97.js"><link rel="prefetch" href="/assets/js/3.7bd32064.js"><link rel="prefetch" href="/assets/js/30.43d740de.js"><link rel="prefetch" href="/assets/js/31.35476f65.js"><link rel="prefetch" href="/assets/js/32.20057b37.js"><link rel="prefetch" href="/assets/js/33.fd9470e1.js"><link rel="prefetch" href="/assets/js/34.01313131.js"><link rel="prefetch" href="/assets/js/35.45efba1c.js"><link rel="prefetch" href="/assets/js/36.74e309b1.js"><link rel="prefetch" href="/assets/js/37.e0900611.js"><link rel="prefetch" href="/assets/js/38.a0e0b9f1.js"><link rel="prefetch" href="/assets/js/39.5284a6de.js"><link rel="prefetch" href="/assets/js/4.642422bc.js"><link rel="prefetch" href="/assets/js/40.932439c4.js"><link rel="prefetch" href="/assets/js/41.ee7ac8cc.js"><link rel="prefetch" href="/assets/js/42.dc683951.js"><link rel="prefetch" href="/assets/js/43.c38eb04b.js"><link rel="prefetch" href="/assets/js/44.3bdc7170.js"><link rel="prefetch" href="/assets/js/45.fdd93da2.js"><link rel="prefetch" href="/assets/js/5.3bc68866.js"><link rel="prefetch" href="/assets/js/6.f8936891.js"><link rel="prefetch" href="/assets/js/8.1a64b73c.js"><link rel="prefetch" href="/assets/js/9.ff7216d2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5ab8ebd7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">山雨光云小集</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://shanyuguangyun.github.io/gitBook" target="_blank" rel="noopener noreferrer" class="nav-link external">
  基础知识
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://qms.shanyuguangyun.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  问卷网页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/shanyuguangyun/leetcode" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/shanyuguangyun" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://shanyuguangyun.github.io/gitBook" target="_blank" rel="noopener noreferrer" class="nav-link external">
  基础知识
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://qms.shanyuguangyun.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  问卷网页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/shanyuguangyun/leetcode" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/shanyuguangyun" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/front/vue.html" class="sidebar-link">Vue知识</a></li><li><a href="/front/nvm.html" class="sidebar-link">Nvm管理Node版本</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>后端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/backend/springboot.html" class="sidebar-link">SpringBoot</a></li><li><a href="/backend/threadpool.html" class="sidebar-link">Treadpool项目中应用</a></li><li><a href="/backend/logback.html" class="sidebar-link">LogBack日志配置</a></li><li><a href="/backend/easyexcel.html" class="sidebar-link">EasyExcel使用</a></li><li><a href="/backend/fdfs.html" class="sidebar-link">FDFS使用</a></li><li><a href="/backend/redis.html" class="sidebar-link">Redis学习</a></li><li><a href="/backend/hadoop.html" class="sidebar-link">Hadoop</a></li><li><a href="/backend/elkf.html" class="sidebar-link">ELK+Filebeat的搭建</a></li><li><a href="/backend/elasticsearch.html" class="sidebar-link">Elasticsearch</a></li><li><a href="/backend/canal.html" aria-current="page" class="active sidebar-link">Canal同步mysql到ES</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/canal.html#概念" class="sidebar-link">概念</a></li><li class="sidebar-sub-header"><a href="/backend/canal.html#选用canal做数据同步" class="sidebar-link">选用canal做数据同步</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/canal.html#_1-开启mysql的binlog-自建-阿里云上的默认开启" class="sidebar-link">1.开启mysql的binlog(自建，阿里云上的默认开启)</a></li><li class="sidebar-sub-header"><a href="/backend/canal.html#_2-下载canal相关组件-我用的1-1-3" class="sidebar-link">2.下载canal相关组件，我用的1.1.3</a></li></ul></li></ul></li><li><a href="/backend/oraclecdc.html" class="sidebar-link">Oracle CDC调研比较</a></li><li><a href="/backend/flinkcdc.html" class="sidebar-link">Flink-CDC同步Oracle全量+增量数据</a></li><li><a href="/backend/kafka.html" class="sidebar-link">Kafka学习总结</a></li><li><a href="/backend/arthas.html" class="sidebar-link">Arthas</a></li><li><a href="/backend/intelij.html" class="sidebar-link">Intelij一些设置</a></li><li><a href="/backend/problem.html" class="sidebar-link">常遇到的问题</a></li><li><a href="/backend/ab.html" class="sidebar-link">ab性能测试</a></li><li><a href="/backend/499.html" class="sidebar-link">一次Nginx499状态码排查</a></li><li><a href="/backend/ssm.html" class="sidebar-link">SSM项目</a></li><li><a href="/backend/oracle.html" class="sidebar-link">Oracle</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>运维手册</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yunwei/vmware.html" class="sidebar-link">VMware</a></li><li><a href="/yunwei/nginx.html" class="sidebar-link">Nginx</a></li><li><a href="/yunwei/linux.html" class="sidebar-link">Linux</a></li><li><a href="/yunwei/vim.html" class="sidebar-link">Vim</a></li><li><a href="/yunwei/supervisor.html" class="sidebar-link">SuperVisor</a></li><li><a href="/yunwei/gitbook.html" class="sidebar-link">GitBook</a></li><li><a href="/yunwei/gitlab.html" class="sidebar-link">GitLab</a></li><li><a href="/yunwei/jenkins.html" class="sidebar-link">Jenkins</a></li><li><a href="/yunwei/redis.html" class="sidebar-link">Redis</a></li><li><a href="/yunwei/prometheus.html" class="sidebar-link">Prometheus</a></li><li><a href="/yunwei/rabbitmq.html" class="sidebar-link">RabbitMq</a></li><li><a href="/yunwei/wiki.html" class="sidebar-link">Confluence Wiki</a></li><li><a href="/yunwei/wakuang.html" class="sidebar-link">脚本攻击处理</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="canal同步mysql到es"><a href="#canal同步mysql到es" class="header-anchor">#</a> Canal同步mysql到ES</h1> <h2 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h2> <p>在大多数情况下，我们使用的是RDBMS。但是随着业务的增长，为了适应各种各样的运营需求，如各类报表，各类业务指标等。不得不做出去规范化的操作。
一般的操作如下：</p> <ul><li>列级处理</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>冗余字段</p></div> <p>在我还是一个刚工作不久在一家体量不是很大的公司工作的时候，为了满足老板有时候奇奇怪怪的需求，不得不去破坏标标致致的表结构，比如在什么订单表上去存储一个奇奇怪怪的字段。这种操作让自己很难受同时也很难向别人解释，到最后大家不得不去每次别捏的看到这个字段在一个设计的很不错的数据表上。</p> <ul><li>表级处理</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>构建宽表，同步写入</p></div> <p>这种操作也不是没有，但是我从来没这么干过 - -！，大概的意思是做完业务操作后，再塞一个DO到宽表中，方便后续运营数据的查询。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>RDBMS物化视图</p></div> <p>视图的方式我目前这家公司就有很多，由于很多业务系统年代较久且数据库用的Oracle，据说2000年左右这种方式非常普遍。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>数据迁移 -&gt; ES、OLAP等</p></div> <p>这种就是借助一些大数据工具或者一些开源的数据同步工具等，对数据进行迁移到ES或者Hive等数据库中，同时方案也是各种各样，工具也是非常多。如阿里云和腾讯的DTS、AWS的DMS、大数据的Sqoop、Datax以及Oracle也有GoldenGate、开源的canal等等</p> <p>当然回归到数据同步到ES，这里可选的一些方案</p> <ul><li>双写</li></ul> <p>意思就是除了向数据库中写入数据外，还同时向es中写入数据，不过不知道大家有无做过需要双写的系统，代码十分累赘，尤其是老系统的改造对改代码的人来说非常痛苦。业务复杂的时候业务代码和构建DO的代码、再加上有时候编码的具体人员经验不是很充分，代码再混淆在一起，实在无法直视。</p> <ul><li>MQ</li></ul> <p>这种其实和双写差不多，意思是写入数据库后再写条消息，中间加了层MQ，双写的同时还加入了MQ组件，复杂度更高了。</p> <ul><li>Datax</li></ul> <p>完全不用对业务代码进行改造，缺点是他只能做全量同步，如果时效性不高，可以考虑。或者和其他混合使用。</p> <ul><li>Canal</li></ul> <p>也不用改造业务代码，且是实时同步的方式。</p> <h2 id="选用canal做数据同步"><a href="#选用canal做数据同步" class="header-anchor">#</a> 选用canal做数据同步</h2> <h3 id="_1-开启mysql的binlog-自建-阿里云上的默认开启"><a href="#_1-开启mysql的binlog-自建-阿里云上的默认开启" class="header-anchor">#</a> 1.开启mysql的binlog(自建，阿里云上的默认开启)</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vim</span> /etc/my.cnf

<span class="token comment"># 配置</span>
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
log-bin<span class="token operator">=</span>mysql-bin <span class="token comment"># 开启 binlog</span>
binlog-format<span class="token operator">=</span>ROW <span class="token comment"># 选择 ROW 模式</span>
server_id <span class="token operator">=</span> <span class="token number">1</span>
</code></pre></div><p>重启mysql，查看配置是否成功</p> <div class="language-shell extra-class"><pre class="language-shell"><code>show variables like <span class="token string">'log_bin%'</span><span class="token punctuation">;</span>

show variables like <span class="token string">'binlog_format%'</span><span class="token punctuation">;</span>
</code></pre></div><p>创建canal用户连接mysql并赋予读取binlog权限</p> <div class="language-shell extra-class"><pre class="language-shell"><code>mysql<span class="token operator">&gt;</span> grant all on *.* to canal@<span class="token string">'%'</span> identified by <span class="token string">'canal'</span><span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> flush privileges<span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-下载canal相关组件-我用的1-1-3"><a href="#_2-下载canal相关组件-我用的1-1-3" class="header-anchor">#</a> 2.下载canal相关组件，我用的1.1.3</h3> <p>1.下载deployer组件，修改conf下面的canal.properties</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /usr/local/canal-server
<span class="token builtin class-name">cd</span> /usr/local/canal-server

<span class="token function">wget</span> https://github.com/alibaba/canal/releases/download/canal-1.1.3/canal.deployer-1.1.3.tar.gz

<span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> canal.deployer-1.1.3.tar.gz
<span class="token function">vim</span> conf/canal.properties

<span class="token comment"># 修改下面两项</span>
canal.instance.parser.parallel <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment"># 单cpu关闭此配置</span>
canal.destinations <span class="token operator">=</span> wds <span class="token comment">#这个是很重要的参数，在这里指定你要创建的实例的名字，比如test1，test2等，逗号隔开</span>

</code></pre></div><p>修改完配置后，要在conf目录下拷贝example到新目录wds</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">cp</span> <span class="token parameter variable">-a</span> example/ wds
</code></pre></div><p>修改wds中的instance.properties</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token assign-left variable">canal.instance.master.address</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:3306　<span class="token comment">#指定要读取binlog的MySQL的IP地址和端口</span>
<span class="token assign-left variable">canal.instance.master.journal.name</span><span class="token operator">=</span>　　　　 <span class="token comment">#从指定的binlog文件开始读取数据</span>
<span class="token assign-left variable">canal.instance.master.position</span><span class="token operator">=</span>　　　　<span class="token comment">#指定偏移量，做过主从复制的应该都理解这两个参数。</span>
　　　　　　　　　　　　　　　　　　　 <span class="token comment">#tips：binlog和偏移量也可以不指定，则canal-server会从当前的位置开始读取。我建议不设置</span>
<span class="token assign-left variable">canal.instance.dbUsername</span><span class="token operator">=</span>canal　　<span class="token comment">#指定连接mysql的用户密码</span>
<span class="token assign-left variable">canal.instance.dbPassword</span><span class="token operator">=</span>canal  
canal.instance.connectionCharset <span class="token operator">=</span> UTF-8　  <span class="token comment">#字符集</span>

<span class="token assign-left variable">canal.instance.filter.regex</span><span class="token operator">=</span>.*<span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">..</span>*　　　　<span class="token comment">#这个是比较重要的参数，匹配库表白名单，比如我只要wds库的user表的增量数据，则这样写 wds.user</span>
</code></pre></div><p>启动deployer</p> <div class="language-shell extra-class"><pre class="language-shell"><code>./bin/startup.sh

<span class="token function">tail</span> <span class="token parameter variable">-f</span> logs/canal/canal.log
</code></pre></div><p>2.下载canal-adapter组件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /usr/local/canal-adapter
<span class="token builtin class-name">cd</span> /usr/local/canal-adapter

<span class="token function">wget</span> https://github.com/alibaba/canal/releases/download/canal-1.1.3/canal.adapter-1.1.3.tar.gz

<span class="token function">tar</span> <span class="token parameter variable">-xzvf</span> canal.adapter-1.1.3.tar.gz
</code></pre></div><p>修改application.yml 主要的参数</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">&quot;^#&quot;</span> application.yml
</code></pre></div><div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">jackson</span><span class="token punctuation">:</span>
    <span class="token key atrule">date-format</span><span class="token punctuation">:</span> yyyy<span class="token punctuation">-</span>MM<span class="token punctuation">-</span>dd HH<span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss
    <span class="token key atrule">time-zone</span><span class="token punctuation">:</span> GMT+8
    <span class="token key atrule">default-property-inclusion</span><span class="token punctuation">:</span> non_null

<span class="token key atrule">canal.conf</span><span class="token punctuation">:</span>
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> tcp <span class="token comment"># kafka rocketMQ　　　　　　　　　　　　　　#模式</span>
  <span class="token key atrule">canalServerHost</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span>11111　　　　　　　　　　 <span class="token comment">#指定canal-server的地址和端口</span>
  <span class="token key atrule">batchSize</span><span class="token punctuation">:</span> <span class="token number">500</span>
  <span class="token key atrule">syncBatchSize</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">timeout</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessKey</span><span class="token punctuation">:</span>
  <span class="token key atrule">secretKey</span><span class="token punctuation">:</span>
　　srcDataSources<span class="token punctuation">:</span>　　　　　　　　　　　　　　　　　　　　<span class="token comment">#数据源配置，从哪里获取数据</span>
　　  defaultDS<span class="token punctuation">:</span>　　　　　　　　　　　　　　　　　　　　　　<span class="token comment">#指定一个名字，在ES的配置中会用到，唯一</span>
　　    url<span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/wds<span class="token punctuation">?</span>useUnicode=true　　　　<span class="token comment">#连接的数据库地址和一个库</span>
　　    username<span class="token punctuation">:</span> root　　　　　　　　　　　　　　　　　　　　　　　　　　　　　<span class="token comment">#数据库的用户和密码</span>
　　    password<span class="token punctuation">:</span> <span class="token number">121212</span>

  <span class="token key atrule">canalAdapters</span><span class="token punctuation">:</span>　　　　　　　　　　　　　　　　　　　　<span class="token comment">#适配器配置</span>
  <span class="token punctuation">-</span> <span class="token key atrule">instance</span><span class="token punctuation">:</span> wds <span class="token comment"># canal instance Name or mq topic name　　　　#指定在canal-server配置的实例</span>
    <span class="token key atrule">groups</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">groupId</span><span class="token punctuation">:</span> g1　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　<span class="token comment">#默认就好，组标示</span>
      <span class="token key atrule">outerAdapters</span><span class="token punctuation">:</span>　　　　　　　　　　　　　　　　　　　　　　　　　　　　<span class="token comment">#输出</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> es　　　　　　　　　　　　　　　　　　　　　　　　　　　　　  <span class="token comment">#输出到哪里？指定es</span>
　　    hosts<span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span>9300　　　　　　　　　　　　　　　　　　　　　　　<span class="token comment">#指定es的地址，注意端口为es的传输端口9300</span>
　　    properties<span class="token punctuation">:</span>　　　　　　　　　　　　　　　　　　
　　      cluster.name<span class="token punctuation">:</span> mycluster　　　　　　　　　　　　　　　　　　　　　　　　　<span class="token comment">#指定es的集群名称</span>
</code></pre></div><p>配置es部分</p> <p>我要同步的表为
<img src="/assets/img/es6.4f8961df.png" alt="es"></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># es目录下有三个示例配置文件，可删除，也可用来参考</span>

<span class="token function">cp</span> /usr/local/canal-adapter/conf/es/mytest_user.yml user.yml

<span class="token function">vim</span> user.yml
</code></pre></div><p><img src="/assets/img/es7.a4a61918.png" alt="es"></p> <p>新建对应的es index。index为wds，type为user，三个属性如下</p> <p><img src="/assets/img/es8.c866dbee.png" alt="es"></p> <p>启动canal-adapter，开始同步数据</p> <div class="language-shell extra-class"><pre class="language-shell"><code>./bin/startup.sh
</code></pre></div><p>启动后先做一次全量同步</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">curl</span> http://127.0.0.1:8081/etl/es/test.yml <span class="token parameter variable">-X</span> POST
</code></pre></div><p>后续在数据库中新增数据，查看数据是否能正常同步</p> <p>查看es数据
<img src="/assets/img/es9.8981041f.png" alt="es"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/backend/elasticsearch.html" class="prev">
        Elasticsearch
      </a></span> <span class="next"><a href="/backend/oraclecdc.html">
        Oracle CDC调研比较
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1211b944.js" defer></script><script src="/assets/js/2.d9cdd38b.js" defer></script><script src="/assets/js/7.6d48973a.js" defer></script>
  </body>
</html>
