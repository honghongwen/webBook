<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Oracle | 山雨光云小集</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="山雨光云小集">
    
    <link rel="preload" href="/assets/css/0.styles.5ab8ebd7.css" as="style"><link rel="preload" href="/assets/js/app.1211b944.js" as="script"><link rel="preload" href="/assets/js/2.d9cdd38b.js" as="script"><link rel="preload" href="/assets/js/4.642422bc.js" as="script"><link rel="prefetch" href="/assets/js/10.8d543d8c.js"><link rel="prefetch" href="/assets/js/11.2cfcc750.js"><link rel="prefetch" href="/assets/js/12.54781427.js"><link rel="prefetch" href="/assets/js/13.f450e900.js"><link rel="prefetch" href="/assets/js/14.f76a28e8.js"><link rel="prefetch" href="/assets/js/15.fb7f9400.js"><link rel="prefetch" href="/assets/js/16.9234d627.js"><link rel="prefetch" href="/assets/js/17.e262864f.js"><link rel="prefetch" href="/assets/js/18.4e875c29.js"><link rel="prefetch" href="/assets/js/19.a995da09.js"><link rel="prefetch" href="/assets/js/20.adc26647.js"><link rel="prefetch" href="/assets/js/21.55c48e84.js"><link rel="prefetch" href="/assets/js/22.3f3a83d0.js"><link rel="prefetch" href="/assets/js/23.deed6bd2.js"><link rel="prefetch" href="/assets/js/24.746bbc50.js"><link rel="prefetch" href="/assets/js/25.2e425410.js"><link rel="prefetch" href="/assets/js/26.0c29c466.js"><link rel="prefetch" href="/assets/js/27.5e6bedfd.js"><link rel="prefetch" href="/assets/js/28.8e4a8ccc.js"><link rel="prefetch" href="/assets/js/29.020ccf97.js"><link rel="prefetch" href="/assets/js/3.7bd32064.js"><link rel="prefetch" href="/assets/js/30.43d740de.js"><link rel="prefetch" href="/assets/js/31.35476f65.js"><link rel="prefetch" href="/assets/js/32.20057b37.js"><link rel="prefetch" href="/assets/js/33.fd9470e1.js"><link rel="prefetch" href="/assets/js/34.01313131.js"><link rel="prefetch" href="/assets/js/35.45efba1c.js"><link rel="prefetch" href="/assets/js/36.74e309b1.js"><link rel="prefetch" href="/assets/js/37.e0900611.js"><link rel="prefetch" href="/assets/js/38.a0e0b9f1.js"><link rel="prefetch" href="/assets/js/39.5284a6de.js"><link rel="prefetch" href="/assets/js/40.932439c4.js"><link rel="prefetch" href="/assets/js/41.ee7ac8cc.js"><link rel="prefetch" href="/assets/js/42.dc683951.js"><link rel="prefetch" href="/assets/js/43.c38eb04b.js"><link rel="prefetch" href="/assets/js/44.3bdc7170.js"><link rel="prefetch" href="/assets/js/45.fdd93da2.js"><link rel="prefetch" href="/assets/js/5.3bc68866.js"><link rel="prefetch" href="/assets/js/6.f8936891.js"><link rel="prefetch" href="/assets/js/7.6d48973a.js"><link rel="prefetch" href="/assets/js/8.1a64b73c.js"><link rel="prefetch" href="/assets/js/9.ff7216d2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5ab8ebd7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">山雨光云小集</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://shanyuguangyun.github.io/gitBook" target="_blank" rel="noopener noreferrer" class="nav-link external">
  基础知识
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://qms.shanyuguangyun.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  问卷网页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/shanyuguangyun/leetcode" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/shanyuguangyun" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://shanyuguangyun.github.io/gitBook" target="_blank" rel="noopener noreferrer" class="nav-link external">
  基础知识
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://qms.shanyuguangyun.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  问卷网页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/shanyuguangyun/leetcode" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LeetCode
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/shanyuguangyun" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/front/vue.html" class="sidebar-link">Vue知识</a></li><li><a href="/front/nvm.html" class="sidebar-link">Nvm管理Node版本</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>后端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/backend/springboot.html" class="sidebar-link">SpringBoot</a></li><li><a href="/backend/threadpool.html" class="sidebar-link">Treadpool项目中应用</a></li><li><a href="/backend/logback.html" class="sidebar-link">LogBack日志配置</a></li><li><a href="/backend/easyexcel.html" class="sidebar-link">EasyExcel使用</a></li><li><a href="/backend/fdfs.html" class="sidebar-link">FDFS使用</a></li><li><a href="/backend/redis.html" class="sidebar-link">Redis学习</a></li><li><a href="/backend/hadoop.html" class="sidebar-link">Hadoop</a></li><li><a href="/backend/elkf.html" class="sidebar-link">ELK+Filebeat的搭建</a></li><li><a href="/backend/elasticsearch.html" class="sidebar-link">Elasticsearch</a></li><li><a href="/backend/canal.html" class="sidebar-link">Canal同步mysql到ES</a></li><li><a href="/backend/oraclecdc.html" class="sidebar-link">Oracle CDC调研比较</a></li><li><a href="/backend/flinkcdc.html" class="sidebar-link">Flink-CDC同步Oracle全量+增量数据</a></li><li><a href="/backend/kafka.html" class="sidebar-link">Kafka学习总结</a></li><li><a href="/backend/arthas.html" class="sidebar-link">Arthas</a></li><li><a href="/backend/intelij.html" class="sidebar-link">Intelij一些设置</a></li><li><a href="/backend/problem.html" class="sidebar-link">常遇到的问题</a></li><li><a href="/backend/ab.html" class="sidebar-link">ab性能测试</a></li><li><a href="/backend/499.html" class="sidebar-link">一次Nginx499状态码排查</a></li><li><a href="/backend/ssm.html" class="sidebar-link">SSM项目</a></li><li><a href="/backend/oracle.html" aria-current="page" class="active sidebar-link">Oracle</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/oracle.html#_1-体系结构" class="sidebar-link">1. 体系结构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/oracle.html#_1-1-逻辑存储结构" class="sidebar-link">1.1 逻辑存储结构</a></li><li class="sidebar-sub-header"><a href="/backend/oracle.html#_1-2-物理存储结构" class="sidebar-link">1.2 物理存储结构</a></li><li class="sidebar-sub-header"><a href="/backend/oracle.html#_1-3-服务器结构" class="sidebar-link">1.3 服务器结构</a></li></ul></li><li class="sidebar-sub-header"><a href="/backend/oracle.html#_2-管理工具" class="sidebar-link">2.管理工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/oracle.html#_2-1-sql-plus" class="sidebar-link">2.1 SQL Plus</a></li><li class="sidebar-sub-header"><a href="/backend/oracle.html#_2-2-sql-developer" class="sidebar-link">2.2 SQL Developer</a></li><li class="sidebar-sub-header"><a href="/backend/oracle.html#_2-3-oracle企业管理器-oem" class="sidebar-link">2.3 Oracle企业管理器（OEM）</a></li><li class="sidebar-sub-header"><a href="/backend/oracle.html#_2-4-数据库配置助手-dbca" class="sidebar-link">2.4 数据库配置助手 （DBCA）</a></li></ul></li><li class="sidebar-sub-header"><a href="/backend/oracle.html#_3-sql基础" class="sidebar-link">3.SQL基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/oracle.html#_3-1-分类" class="sidebar-link">3.1 分类</a></li><li class="sidebar-sub-header"><a href="/backend/oracle.html#_3-2-用户模式" class="sidebar-link">3.2 用户模式</a></li></ul></li><li class="sidebar-sub-header"><a href="/backend/oracle.html#_4-pl-sql" class="sidebar-link">4.PL/SQL</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/oracle.html#_4-1-数据类型" class="sidebar-link">4.1 数据类型</a></li><li class="sidebar-sub-header"><a href="/backend/oracle.html#_4-2-语法" class="sidebar-link">4.2 语法</a></li><li class="sidebar-sub-header"><a href="/backend/oracle.html#_4-3-游标" class="sidebar-link">4.3 游标</a></li><li class="sidebar-sub-header"><a href="/backend/oracle.html#_4-4-异常" class="sidebar-link">4.4 异常</a></li><li class="sidebar-sub-header"><a href="/backend/oracle.html#_4-5-过程、函数、触发器、包" class="sidebar-link">4.5 过程、函数、触发器、包</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>运维手册</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yunwei/vmware.html" class="sidebar-link">VMware</a></li><li><a href="/yunwei/nginx.html" class="sidebar-link">Nginx</a></li><li><a href="/yunwei/linux.html" class="sidebar-link">Linux</a></li><li><a href="/yunwei/vim.html" class="sidebar-link">Vim</a></li><li><a href="/yunwei/supervisor.html" class="sidebar-link">SuperVisor</a></li><li><a href="/yunwei/gitbook.html" class="sidebar-link">GitBook</a></li><li><a href="/yunwei/gitlab.html" class="sidebar-link">GitLab</a></li><li><a href="/yunwei/jenkins.html" class="sidebar-link">Jenkins</a></li><li><a href="/yunwei/redis.html" class="sidebar-link">Redis</a></li><li><a href="/yunwei/prometheus.html" class="sidebar-link">Prometheus</a></li><li><a href="/yunwei/rabbitmq.html" class="sidebar-link">RabbitMq</a></li><li><a href="/yunwei/wiki.html" class="sidebar-link">Confluence Wiki</a></li><li><a href="/yunwei/wakuang.html" class="sidebar-link">脚本攻击处理</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="oracle"><a href="#oracle" class="header-anchor">#</a> Oracle</h1> <p>这两年接触Oracle的频率越来越高了，有些基础知识记录一下。</p> <h2 id="_1-体系结构"><a href="#_1-体系结构" class="header-anchor">#</a> 1. 体系结构</h2> <ul><li>逻辑存储结构
<ul><li>数据块</li> <li>数据区</li> <li>段</li> <li>表空间</li></ul></li> <li>物理存储结构
<ul><li>数据文件</li> <li>控制文件</li> <li>日志文件</li> <li>服务器参数文件</li> <li>密码文件、警告文件、跟踪文件</li></ul></li> <li>服务器结构
<ul><li>系统全局区</li> <li>程序全局区</li> <li>前台进程</li> <li>后台进程</li></ul></li> <li>数据字典</li></ul> <p><img src="/assets/img/oracle1.183d010f.png" alt="服务器结构"></p> <h3 id="_1-1-逻辑存储结构"><a href="#_1-1-逻辑存储结构" class="header-anchor">#</a> 1.1 逻辑存储结构</h3> <h4 id="_1-1-1-数据块"><a href="#_1-1-1-数据块" class="header-anchor">#</a> 1.1.1 数据块</h4> <p>逻辑结构中最小单元，同时也是数据库输入/输出操作的最小存储单位。总是操作系统块的整数倍。操作系统2048 B，oracle 8192 B</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> col name format a30
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> col <span class="token keyword">value</span> format a20
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span><span class="token keyword">value</span> <span class="token keyword">from</span> v$parameter <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'db_block_size'</span> <span class="token punctuation">;</span>
</code></pre></div><blockquote><p>块头：数据块基本信息，如物理地址、所属段的类型。
表目录：若存的数据是表数据，则存储表相关信息。
行目录：若存行数据，则行信息会被记录。
空余：未使用区域，用于新插入和已经存在行的更新。
行数据：存放表数据和索引数据。已被数据行占用。</p></blockquote> <h4 id="_1-1-2-数据区"><a href="#_1-1-2-数据区" class="header-anchor">#</a> 1.1.2 数据区</h4> <p>一组连续的数据块组成，当一个段中所有空间被用完，会自动分配一个新区。</p> <h4 id="_1-3-段"><a href="#_1-3-段" class="header-anchor">#</a> 1.3 段</h4> <p>一个或多个数据区构成，不是存储空间分配单位，而是逻辑结构，属于数据对象。每建立一个数据对象（表、索引）时，为其创建一个段。包含的数据区可以不连续。</p> <blockquote><p>数据段：保存表中记录，创建表时，oracle为表创建数据段，当数据量增大，数据段亦通过增加数据区方式增大。
索引段：建立索引时，建立索引段，名称同名。
回滚段：保存回滚条目，撤销未提交的操作，当开始一个事务时，oracle为其分配回滚段。
临时段：临时存储空间。</p></blockquote> <h4 id="_1-4-表空间"><a href="#_1-4-表空间" class="header-anchor">#</a> 1.4 表空间</h4> <p>oracle使用表空间将相关的逻辑结构（段、数据区）等组合在一起，是最大的逻辑划分单元，用来存放如数据表、索引、回滚段等数据对象。任何数据对象创建时必须指定存储在某个表空间中。<br>
表空间与物理数据文件对应，一个表空间由一个或多个数据文件组成。</p> <p>默认表空间</p> <blockquote><p>SYSTEM：系统内部表，数据字典的数据，如表名、列名、用户名等。
SYSAUX：SYSTEM的辅助表空间，降低SYSTEM负荷。主要为除数据字典外的其他数据对象。
UNDO：在修改删除时，oracle自动将变更前数据临时存储在撤销表空间。在commit之后，根据系统设置的保留时间来释放掉这部分空间。
USERS：建议用户使用的表空间，样例用户scott就使用的该空间。</p></blockquote> <p>用户应根据实际情况创建自定义表空间，以区分用户数据和系统数据，同时存储在不同磁盘上，减少IO冲突。</p> <h3 id="_1-2-物理存储结构"><a href="#_1-2-物理存储结构" class="header-anchor">#</a> 1.2 物理存储结构</h3> <h4 id="_1-2-1-数据文件"><a href="#_1-2-1-数据文件" class="header-anchor">#</a> 1.2.1 数据文件</h4> <p>在创建表空间时，oracle会创建对应的数据文件。一个表空间有一个或多个数据文件，具体如何存储由oracle决定。<br>
数据读取时，oracle从数据文件中读取入高速缓冲区，再次读取时则优先走高速缓冲区。在修改和写入时，将数据保存在数据缓冲区，具体由DBWR进程决定何时写入数据文件。减少磁盘IO。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> col file_name <span class="token keyword">for</span> a50<span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">set</span> linesize <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> file_name<span class="token punctuation">,</span>tablespace_name <span class="token keyword">from</span> dba_data_files<span class="token punctuation">;</span>
</code></pre></div><blockquote><p>系统数据文件
撤销数据文件
用户数据文件</p></blockquote> <p>其实和表空间基本对应。</p> <h4 id="_1-2-2-控制文件"><a href="#_1-2-2-控制文件" class="header-anchor">#</a> 1.2.2 控制文件</h4> <p>控制文件记录了数据库的物理结构，如数据库名、数据文件和日志文件的名字和位置、数据库建立时间等。<br>
所以启动实例时，oracle会打开该文件，正常后才会加载并打开数据库。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> col name format a60<span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> name <span class="token keyword">from</span> v$controlfile<span class="token punctuation">;</span>
</code></pre></div><blockquote><p>当Oracle实例正常启动时，系统首先要访问的是初始化参数文件SPFILE；然后Oracle为系统全局区(SGA)分配内存，这时Oracle实例处于安装状态，并且控制文件处于打开状态；接下来Oracle会自动读出控制文件中的所有数据文件和日志文件的信息，并打开当前数据库中所有的数据文件和所有的日志文件以供用户访问。</p></blockquote> <h4 id="_1-2-3-日志文件"><a href="#_1-2-3-日志文件" class="header-anchor">#</a> 1.2.3 日志文件</h4> <p>对数据所作修改，数据库所作修改几乎都会记录到日志文件中。在出问题时，可有通过日志文件得到原始数据。</p> <ul><li><strong>重做日志文件(redo log file)</strong><br>
所有的修改、增加、删除等更改信息，以及创建表、索引等变化。都会被记录到redo log中。用户commit时，会先将原始数据写入日志，日志写入成功后，才会将新记录传递至之后流程。</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> col member <span class="token keyword">for</span> a50<span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> member <span class="token keyword">from</span> v$logfile<span class="token punctuation">;</span>
</code></pre></div><blockquote><p>oracle在运行中产生的日志，会先被临时存在SGA（系统全局区）的重做日志缓冲区中，当用户commit或缓冲区满1/3时，日志写入进程LGWR将日志从缓冲区读出，然后将其写入日志文件组中序列较小的文件内，在一个日志组被写满后，接着写入第二个组，然后到最后一个组写满后重复该操作写第一个日志组。</p></blockquote> <blockquote><p>为保证数据库系统安全性，oracle实例会使用一个日志线程来记录数据库变化。日志线程由若干个“日志组”构成，每个日志组由一个或多个日志文件构成。</p></blockquote> <ul><li><strong>归档日志文件(archive log file)</strong>
对于上述设计，回到第一个日志组覆写日志，则会将一部分较早日志覆盖。因此可有设置为归档模式运行oracle。在所有日志组被写满后，归档模式中会由ARCH归档进程将日志读取后写入归档日志中。
LGWR进程需等待ARCH进程结束后才能开始覆写日志，所以会影响性能。所以默认情况下不会使用归档模式启动。</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment"># 查询启动模式</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> col name format a30<span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> dbid<span class="token punctuation">,</span>name<span class="token punctuation">,</span>log_mode <span class="token keyword">from</span> v$<span class="token keyword">database</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment"># 查询归档日志所在路径</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">set</span> pagesize <span class="token number">30</span><span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">show</span> parameter log_archive_dest<span class="token punctuation">;</span>
</code></pre></div><h4 id="_1-2-4-服务器参数文件"><a href="#_1-2-4-服务器参数文件" class="header-anchor">#</a> 1.2.4 服务器参数文件</h4> <p>记录oracle的基本信息（数据库名、控制文件路径、日志缓冲大小log_buffer等）。在实例启动之前，oracle会首先读取SPFILE中设置的这些参数，然后根据这些初始化参数来配置和启动实例。
该文件最好不能直接编辑，而是由oracle自己维护，最好通过OEM企业管理器或者alter system命令修改，改完后会自动写入到SPFILE中。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> col name <span class="token keyword">for</span> a30<span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> col <span class="token keyword">value</span> <span class="token keyword">for</span> a30<span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span><span class="token keyword">value</span><span class="token punctuation">,</span>ismodified <span class="token keyword">from</span> v$parameter<span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment"># 显示服务器参数</span>
<span class="token keyword">show</span> parameter<span class="token punctuation">;</span>
</code></pre></div><h4 id="_1-2-5-密码文件、警告文件、跟踪文件"><a href="#_1-2-5-密码文件、警告文件、跟踪文件" class="header-anchor">#</a> 1.2.5 密码文件、警告文件、跟踪文件</h4> <blockquote><p>密码文件是Oracle系统用于验证sysdba权限的二进制文件，当远程用户以sysdba或sysoper连接到数据库时，一般要用密码文件验证。
默认存储位置在%dbhome_1%\database目录下，命名格式为PWD<sid>，其中sid表示数据库实例名。</sid></p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code>C:\<span class="token operator">&gt;</span>ORAPWD <span class="token keyword">FILE</span><span class="token operator">=</span><span class="token operator">&lt;</span>filename<span class="token operator">&gt;</span> PASSWORD<span class="token operator">=</span><span class="token operator">&lt;</span>password<span class="token operator">&gt;</span> ENTRIES<span class="token operator">=</span><span class="token operator">&lt;</span>max_users<span class="token operator">&gt;</span>
</code></pre></div><blockquote><p>警告文件alert_orcl.log是oracle日常运行中的日志。包括实例启动、关闭，建立空间、错误信息等。最好定期删除。</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token keyword">value</span> <span class="token keyword">FROM</span> v$diag_info <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">'Diag Trace'</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>跟踪文件包括后台进程跟踪orcl_cjq0_xxx.trc和用户进程跟踪orcl_ora_xxx.trc。后台进程记录后台进程的警告或错误消息。用户进程用于记载用户相关的信息，主要跟踪sql语句。通过该文件，可以判断sql执行性能。</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token keyword">value</span> <span class="token keyword">from</span> v$parameter <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'user_dump_dest'</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_1-3-服务器结构"><a href="#_1-3-服务器结构" class="header-anchor">#</a> 1.3 服务器结构</h3> <p><img src="/assets/img/oracle2.96506d74.png" alt=""></p> <h4 id="_1-3-1-系统全局区-sga"><a href="#_1-3-1-系统全局区-sga" class="header-anchor">#</a> 1.3.1 系统全局区（SGA）</h4> <p>所有用户进程共享的一块内存区域。数据库实例启动时加载内存。实例关闭则关闭。</p> <p><strong>高速数据缓冲区</strong></p> <blockquote><p>查询时，会先走高速缓冲区查询数据，若无，再打开数据文件。</p></blockquote> <ul><li>脏数据区：已经被修改过的数据，等待被写入数据文件。commit后BGWR进程写入。</li> <li>空闲区：待写入。</li> <li>保留区：缓存区。</li></ul> <p><strong>重做日志缓冲区</strong>
修改数据时，先会写入重做日志缓冲区，然后由LGWR进程将其写入重做日志文件中。</p> <p>重做日志大小由log_buffer参数指定。通常较大的日志缓冲区能减少磁盘io，提升性能。该参数支持动态修改。</p> <p><strong>共享池</strong>
SGA保留区域，用于缓存sql语句、数据字典、资源锁等。</p> <ul><li>库高速缓冲区</li></ul> <blockquote><p>主要包含共享sql和私有sql两个区，存储最近的sql语句、执行计划等。执行相同sql时能直接获取执行计划，无需再解析。私有区存变量等。</p></blockquote> <ul><li>字典高速缓冲区</li></ul> <blockquote><p>字典高速缓冲区用于存储Oracle系统内部管理所需要的数据字典信息，如用户名、数据对象和权限等</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">alter</span> system <span class="token keyword">set</span> shared_pool_size<span class="token operator">=</span><span class="token number">30</span>m<span class="token punctuation">;</span>
</code></pre></div><p><strong>大型池</strong></p> <blockquote><p>大型池在SGA区中不是必需的内存结构，只有在某些特殊情况下，实例才需要使用大型池来减轻共享池的访问压力，常用的情况有以下几种。 当使用恢复管理器进行备份和恢复操作时，大型池将作为I/O缓冲区使用。 当使用I/O Slave仿真异步I/O功能时，大型池将被当作I/O缓冲区使用。 执行具有大量排序操作的SQL语句。当使用并行查询时，大型池将作为并行查询进程彼此交换信息的地方。</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">alter</span> system <span class="token keyword">set</span> large_pool_size <span class="token operator">=</span> <span class="token number">16</span>m<span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">show</span> parameter large_pool_size<span class="token punctuation">;</span>
</code></pre></div><p><strong>Java池</strong></p> <blockquote><p>Java池用来提供内存空间给Java虚拟机使用，目的是支持在数据库中运行Java程序包，其大小由java_pool_size参数决定。</p></blockquote> <p><strong>Oracle流池</strong></p> <blockquote><p>Oracle流池用于在数据库与数据库之间进行信息共享。如果没有用到Oracle流，就不需要设置该池。Oracle流池的大小由参数streams_pool_size决定。</p></blockquote> <h4 id="_1-3-2-程序全局区-pga"><a href="#_1-3-2-程序全局区-pga" class="header-anchor">#</a> 1.3.2 程序全局区（PGA）</h4> <blockquote><p>又称作用户进程全局区，它的内存区在进程私有区中，而不是在共享区中。PGA是一个全局区，可以把代码、全局变量和数据结构都存储在其中，但区域内的资源并不像SGA一样可被所有的用户进程所共享，而是每个Oracle服务器进程都只拥有属于自己的那部分PGA资源。在程序全局区中，一个服务进程只能访问属于它自己的那部分PGA资源区，各个服务进程的PGA的总和即为实例的PGA的大小。通常PGA由私有SQL区和会话区组成。</p></blockquote> <p><strong>私有SQL区</strong></p> <blockquote><p>私有SQL区用于存储变量以及SQL语句运行时的内存结构信息，每个用户连接到实例时，都会在实例中创建一个会话。这些会话可能会在SGA区中创建一个共享SQL区，但在PGA区中可能会创建多个私有SQL区。把一个私有SQL区与对应的共享SQL区合并在一起，就可以获得一条SQL语句的完整缓存数据。
另外，每个会话的私有SQL区都可以再分为静态区和动态区两部分。静态区的信息在会话过程中保持不变，只有当会话结束时，静态区才会被释放；而动态区的信息在整个会话过程中是不断变化的，一旦SQL语句执行完毕，即使会话还没有结束，动态区也会被释放。</p></blockquote> <p><strong>会话区</strong></p> <blockquote><p>会话区用于存储用户的会话信息（如登录用户名）。如果数据库处于共享服务器连接模式下，则会话区将位于SGA中，而不是PGA中，用户特别需要注意这一点。</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">show</span> parameter pga<span class="token punctuation">;</span>
</code></pre></div><h4 id="_1-3-3-前台进程"><a href="#_1-3-3-前台进程" class="header-anchor">#</a> 1.3.3 前台进程</h4> <p><strong>用户进程</strong></p> <blockquote><p>用户进程是指那些能够产生或执行SQL语句的应用程序，无论是SQL<em>Plus，还是其他应用程序，只要是能生成或执行SQL语句，都被称作用户进程。在用户进程中有两个非常重要的概念，即连接和会话。连接是一个用户进程与实例之间建立的通信渠道，这个渠道可以通过操作系统上的相关通信机制或网络连接来实现；会话是指在用户进程与实例之间建立连接后形成的用户与实例之间的交互方式，一般是用户发出请求，数据库实例为用户返回响应消息的方式。例如，用户在SQL</em>Plus中发出connect system/1qaz2wsx的请求命令，若用户名和密码都正确，则数据库实例将返回“已连接”的响应消息。</p></blockquote> <p><strong>服务器进程</strong></p> <blockquote><p>服务器进程是用于处理用户会话过程中向数据库实例发出的SQL语句或SQL*Plus命令，它可以分为专用服务器模式和共享服务器模式。在专用服务器模式下，每个用户进程都有一个专用的服务器进程，这个服务器进程代表用户进程执行SQL语句，必要时还可以回传执行结果给用户进程；在共享服务器模式下，每个用户进程不直接与服务器进程连接，而是连接到分派程序，每个分派程序可以同时连接多个用户进程。</p></blockquote> <h4 id="_1-3-4-后台进程"><a href="#_1-3-4-后台进程" class="header-anchor">#</a> 1.3.4 后台进程</h4> <p><img src="/assets/img/oracle3.6bba217e.png" alt=""></p> <blockquote><p>实例的重要组成部分。这组后台进程有若干个，如图2.16所示。其中SMON、PMON、DBWR、LGWR和CKPT这5个后台进程必须正常启动，否则将导致数据库实例崩溃。此外，还有很多辅助进程，用于实现相关的辅助功能，如果这些辅助进程发生问题，仅使某些功能受到影响，一般不会导致数据库实例崩溃。下面对其中的主要进程进行讲</p></blockquote> <p><strong>数据写入进程（DBWR）</strong>
将高速缓冲区中修改过的数据写到数据文件。写入时机：</p> <ul><li>高速缓冲区中无空闲数据块可写入修改的新数据。</li> <li>检查点进程启动后，会强制要求DBWR将某些数据块写入数据文件。</li> <li>当修改过的脏数据块在高速缓冲区中存储超过3s时，会自行将其写入。</li></ul> <p><strong>检查点进程（CKPT）</strong>
可以看作一个事件，当其发生时，CKPT会要求DBWR将某些脏数据块写入数据文件。用户操作数据时，会产生大量重做日志，日志进程将日志写入文件组中，当发生日志切换时（从一个组到另一个组），就会启动CKPT。</p> <p><strong>日志写入进程（LGWR）</strong>
oracle运行时的重做日志会先被记录在SGA的重做日志缓冲区，当commit或缓冲区满1/3或日志存储超过3s时，LGWR会将其读取并写入文件组中序号较小的文件。</p> <p><strong>归档进程（ARCH）</strong>
可选进程，只有归档模式下会起作用，在各日志组被写满，即将被覆盖前。ARCH会将即将被覆盖的日志读出写入到归档日志中。</p> <p><strong>系统监控进程（SMON）</strong></p> <p><strong>进程监控进程（PMON）</strong></p> <h4 id="_1-3-5-数据字典"><a href="#_1-3-5-数据字典" class="header-anchor">#</a> 1.3.5 数据字典</h4> <p>oracle存储数据内部信息的地方，描述了内部的运行和管理情况。
由前缀和后缀组成，下划线_连接。</p> <ul><li>dba_：数据库实例的所有对象信息。</li> <li>v$_: 当前实例的动态视图，系统管理和系统优化方面。内存和磁盘情况。</li> <li>user_: 记录用户的对象信息。</li> <li>gv_: 分布式环境下所有实例的动态视图。</li> <li>all_: 记录用户的对象信息及被授权访问的对象信息。</li></ul> <p><img src="/assets/img/oracle4.a86cef27.png" alt=""></p> <p><img src="/assets/img/oracle5.2980a4ed.png" alt=""></p> <h2 id="_2-管理工具"><a href="#_2-管理工具" class="header-anchor">#</a> 2.管理工具</h2> <h3 id="_2-1-sql-plus"><a href="#_2-1-sql-plus" class="header-anchor">#</a> 2.1 SQL Plus</h3> <div class="language-sql extra-class"><pre class="language-sql"><code>SQLPLUS username<span class="token punctuation">[</span><span class="token operator">/</span>password<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">@connect_identifier</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">AS</span> SYSOPER<span class="token operator">|</span>SYSDBA<span class="token punctuation">]</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code>sqlplus <span class="token operator">/</span><span class="token keyword">as</span> sysdba
<span class="token keyword">create</span> <span class="token keyword">user</span> scott identified <span class="token keyword">by</span> tiger<span class="token punctuation">;</span>

<span class="token keyword">ALTER</span> <span class="token keyword">USER</span> scott <span class="token keyword">DEFAULT</span> <span class="token keyword">TABLESPACE</span> USERS<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">USER</span> scott <span class="token keyword">TEMPORARY</span> <span class="token keyword">TABLESPACE</span> <span class="token keyword">TEMP</span><span class="token punctuation">;</span>

<span class="token keyword">GRANT</span> dba <span class="token keyword">TO</span> scott<span class="token punctuation">;</span>
<span class="token keyword">CONNECT</span> scott<span class="token operator">/</span>tiger<span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 创建数据表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> dept <span class="token punctuation">(</span>
deptno    NUMBER<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">CONSTRAINT</span> PK_DEPT <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
dname    VARCHAR2<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>
loc        VARCHAR2<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> emp <span class="token punctuation">(</span>
empno    NUMBER<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">CONSTRAINT</span> PK_EMP <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
ename    VARCHAR2<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
job        VARCHAR2<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
mgr        NUMBER<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
hiredate    <span class="token keyword">DATE</span><span class="token punctuation">,</span>
sal        NUMBER<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
comm    NUMBER<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
deptno    NUMBER<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">CONSTRAINT</span> FK_DEPTNO <span class="token keyword">REFERENCES</span> DEPT
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> bonus <span class="token punctuation">(</span>
enamE    VARCHAR2<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>    <span class="token punctuation">,</span>
job        VARCHAR2<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>  <span class="token punctuation">,</span>
sal        NUMBER<span class="token punctuation">,</span>
comm    NUMBER
<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> salgrade <span class="token punctuation">(</span>
grade        NUMBER<span class="token punctuation">,</span>
losal        NUMBER<span class="token punctuation">,</span>
hisal        NUMBER
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 插入测试数据 —— dept</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> dept <span class="token keyword">VALUES</span>    <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">'ACCOUNTING'</span><span class="token punctuation">,</span><span class="token string">'NEW YORK'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> dept <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token string">'RESEARCH'</span><span class="token punctuation">,</span><span class="token string">'DALLAS'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> dept <span class="token keyword">VALUES</span>    <span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token string">'SALES'</span><span class="token punctuation">,</span><span class="token string">'CHICAGO'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> dept <span class="token keyword">VALUES</span>    <span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token string">'OPERATIONS'</span><span class="token punctuation">,</span><span class="token string">'BOSTON'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 插入测试数据 —— emp</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7369</span><span class="token punctuation">,</span><span class="token string">'SMITH'</span><span class="token punctuation">,</span><span class="token string">'CLERK'</span><span class="token punctuation">,</span><span class="token number">7902</span><span class="token punctuation">,</span>to_date<span class="token punctuation">(</span><span class="token string">'17-12-1980'</span><span class="token punctuation">,</span><span class="token string">'dd-mm-yyyy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">800</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7499</span><span class="token punctuation">,</span><span class="token string">'ALLEN'</span><span class="token punctuation">,</span><span class="token string">'SALESMAN'</span><span class="token punctuation">,</span><span class="token number">7698</span><span class="token punctuation">,</span>to_date<span class="token punctuation">(</span><span class="token string">'20-2-1981'</span><span class="token punctuation">,</span><span class="token string">'dd-mm-yyyy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1600</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7521</span><span class="token punctuation">,</span><span class="token string">'WARD'</span><span class="token punctuation">,</span><span class="token string">'SALESMAN'</span><span class="token punctuation">,</span><span class="token number">7698</span><span class="token punctuation">,</span>to_date<span class="token punctuation">(</span><span class="token string">'22-2-1981'</span><span class="token punctuation">,</span><span class="token string">'dd-mm-yyyy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1250</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7566</span><span class="token punctuation">,</span><span class="token string">'JONES'</span><span class="token punctuation">,</span><span class="token string">'MANAGER'</span><span class="token punctuation">,</span><span class="token number">7839</span><span class="token punctuation">,</span>to_date<span class="token punctuation">(</span><span class="token string">'2-4-1981'</span><span class="token punctuation">,</span><span class="token string">'dd-mm-yyyy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2975</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7654</span><span class="token punctuation">,</span><span class="token string">'MARTIN'</span><span class="token punctuation">,</span><span class="token string">'SALESMAN'</span><span class="token punctuation">,</span><span class="token number">7698</span><span class="token punctuation">,</span>to_date<span class="token punctuation">(</span><span class="token string">'28-9-1981'</span><span class="token punctuation">,</span><span class="token string">'dd-mm-yyyy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1250</span><span class="token punctuation">,</span><span class="token number">1400</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7698</span><span class="token punctuation">,</span><span class="token string">'BLAKE'</span><span class="token punctuation">,</span><span class="token string">'MANAGER'</span><span class="token punctuation">,</span><span class="token number">7839</span><span class="token punctuation">,</span>to_date<span class="token punctuation">(</span><span class="token string">'1-5-1981'</span><span class="token punctuation">,</span><span class="token string">'dd-mm-yyyy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2850</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7782</span><span class="token punctuation">,</span><span class="token string">'CLARK'</span><span class="token punctuation">,</span><span class="token string">'MANAGER'</span><span class="token punctuation">,</span><span class="token number">7839</span><span class="token punctuation">,</span>to_date<span class="token punctuation">(</span><span class="token string">'9-6-1981'</span><span class="token punctuation">,</span><span class="token string">'dd-mm-yyyy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2450</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7788</span><span class="token punctuation">,</span><span class="token string">'SCOTT'</span><span class="token punctuation">,</span><span class="token string">'ANALYST'</span><span class="token punctuation">,</span><span class="token number">7566</span><span class="token punctuation">,</span>to_date<span class="token punctuation">(</span><span class="token string">'13-07-87'</span><span class="token punctuation">,</span><span class="token string">'dd-mm-yyyy'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">85</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7839</span><span class="token punctuation">,</span><span class="token string">'KING'</span><span class="token punctuation">,</span><span class="token string">'PRESIDENT'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span>to_date<span class="token punctuation">(</span><span class="token string">'17-11-1981'</span><span class="token punctuation">,</span><span class="token string">'dd-mm-yyyy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">5000</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7844</span><span class="token punctuation">,</span><span class="token string">'TURNER'</span><span class="token punctuation">,</span><span class="token string">'SALESMAN'</span><span class="token punctuation">,</span><span class="token number">7698</span><span class="token punctuation">,</span>to_date<span class="token punctuation">(</span><span class="token string">'8-9-1981'</span><span class="token punctuation">,</span><span class="token string">'dd-mm-yyyy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1500</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7876</span><span class="token punctuation">,</span><span class="token string">'ADAMS'</span><span class="token punctuation">,</span><span class="token string">'CLERK'</span><span class="token punctuation">,</span><span class="token number">7788</span><span class="token punctuation">,</span>to_date<span class="token punctuation">(</span><span class="token string">'13-07-87'</span><span class="token punctuation">,</span><span class="token string">'dd-mm-yyyy'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">51</span><span class="token punctuation">,</span><span class="token number">1100</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7900</span><span class="token punctuation">,</span><span class="token string">'JAMES'</span><span class="token punctuation">,</span><span class="token string">'CLERK'</span><span class="token punctuation">,</span><span class="token number">7698</span><span class="token punctuation">,</span>to_date<span class="token punctuation">(</span><span class="token string">'3-12-1981'</span><span class="token punctuation">,</span><span class="token string">'dd-mm-yyyy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">950</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7902</span><span class="token punctuation">,</span><span class="token string">'FORD'</span><span class="token punctuation">,</span><span class="token string">'ANALYST'</span><span class="token punctuation">,</span><span class="token number">7566</span><span class="token punctuation">,</span>to_date<span class="token punctuation">(</span><span class="token string">'3-12-1981'</span><span class="token punctuation">,</span><span class="token string">'dd-mm-yyyy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7934</span><span class="token punctuation">,</span><span class="token string">'MILLER'</span><span class="token punctuation">,</span><span class="token string">'CLERK'</span><span class="token punctuation">,</span><span class="token number">7782</span><span class="token punctuation">,</span>to_date<span class="token punctuation">(</span><span class="token string">'23-1-1982'</span><span class="token punctuation">,</span><span class="token string">'dd-mm-yyyy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1300</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 插入测试数据 —— salgrade</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> salgrade <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">700</span><span class="token punctuation">,</span><span class="token number">1200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> salgrade <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1201</span><span class="token punctuation">,</span><span class="token number">1400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> salgrade <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1401</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> salgrade <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2001</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> salgrade <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3001</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 事务提交</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept<span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-2-sql-developer"><a href="#_2-2-sql-developer" class="header-anchor">#</a> 2.2 SQL Developer</h3> <h3 id="_2-3-oracle企业管理器-oem"><a href="#_2-3-oracle企业管理器-oem" class="header-anchor">#</a> 2.3 Oracle企业管理器（OEM）</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> dbms_xdb_config<span class="token punctuation">.</span>gethttpsport <span class="token keyword">FROM</span> DUAL<span class="token punctuation">;</span>
<span class="token keyword">exec</span> DBMS_XDB_CONFIG<span class="token punctuation">.</span>SETHTTPSPORT<span class="token punctuation">(</span><span class="token number">5500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> dbms_xdb_config<span class="token punctuation">.</span>gethttpsport <span class="token keyword">FROM</span> DUAL<span class="token punctuation">;</span>

<span class="token comment"># 访问，新版网页版只能看性能指标了</span>
https:<span class="token comment">//localhost:5500/em</span>
</code></pre></div><h3 id="_2-4-数据库配置助手-dbca"><a href="#_2-4-数据库配置助手-dbca" class="header-anchor">#</a> 2.4 数据库配置助手 （DBCA）</h3> <h2 id="_3-sql基础"><a href="#_3-sql基础" class="header-anchor">#</a> 3.SQL基础</h2> <h3 id="_3-1-分类"><a href="#_3-1-分类" class="header-anchor">#</a> 3.1 分类</h3> <ul><li>数据查询（DQL）
select xxx</li> <li>数据操纵（DML）
insert update delete xxx</li> <li>事物控制（TCL）
commit rollback savepoint</li> <li>数据定义（DDL）
create alter drop table...</li> <li>数据控制（DCL）
grant revoke</li></ul> <h3 id="_3-2-用户模式"><a href="#_3-2-用户模式" class="header-anchor">#</a> 3.2 用户模式</h3> <h4 id="_3-2-1-模式-模式对象"><a href="#_3-2-1-模式-模式对象" class="header-anchor">#</a> 3.2.1 模式&amp;模式对象</h4> <blockquote><p>在Oracle数据库中，为了便于管理用户创建的数据库对象（如数据表、索引、视图等），引入了模式的概念，某个用户创建的数据库对象都属于该用户模式。</p></blockquote> <blockquote><p>模式是数据库对象的集合，为一个数据库用户所有，并且具有与该用户相同的名称，如system模式、scott模式等。在一个模式内部不可以直接访问其他模式的数据库对象，即使在具有访问权限的情况下，也需要指定模式名称才可以访问其他模式的数据库对象。模式对象是由用户创建的逻辑结构，用以存储或引用数据。例如，前面章节中所讲过的段（如表、索引等），以及用户所拥有的其他非段的数据库对象。这些非段的数据库对象通常包括约束、视图、同义词、过程以及程序包等。简而言之，模式与模式对象之间的关系就是拥有与被拥有的关系，即模式拥有模式对象，而模式对象被模式所拥有。</p></blockquote> <h4 id="_3-2-2-检索数据"><a href="#_3-2-2-检索数据" class="header-anchor">#</a> 3.2.2 检索数据</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> {<span class="token punctuation">[</span> <span class="token keyword">DISTINCT</span> <span class="token operator">|</span> <span class="token keyword">ALL</span> <span class="token punctuation">]</span> <span class="token keyword">columns</span> <span class="token operator">|</span> <span class="token operator">*</span>}
<span class="token punctuation">[</span><span class="token keyword">INTO</span> table_name<span class="token punctuation">]</span>
<span class="token keyword">FROM</span> {<span class="token keyword">tables</span> <span class="token operator">|</span> views <span class="token operator">|</span> other <span class="token keyword">select</span>}
<span class="token punctuation">[</span><span class="token keyword">WHERE</span> conditions<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">columns</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">HAVING</span> conditions<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">columns</span><span class="token punctuation">]</span>
</code></pre></div><h4 id="_3-2-3-基本语法"><a href="#_3-2-3-基本语法" class="header-anchor">#</a> 3.2.3 基本语法</h4> <p><strong>处理null</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> ename<span class="token punctuation">,</span>sal<span class="token punctuation">,</span>comm<span class="token punctuation">,</span>sal<span class="token operator">+</span>comm <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
</code></pre></div><p>如果comm是null, sal+comm也是null，不合理。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> ename<span class="token punctuation">,</span>sal<span class="token punctuation">,</span>comm<span class="token punctuation">,</span>sal<span class="token operator">+</span>nvl<span class="token punctuation">(</span>comm<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
</code></pre></div><p><strong>连接字符串</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> ename <span class="token operator">||</span> <span class="token string">''''</span><span class="token operator">||</span><span class="token string">'s job is '</span><span class="token operator">||</span>job <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> concat<span class="token punctuation">(</span>concat<span class="token punctuation">(</span>ename<span class="token punctuation">,</span> <span class="token string">'''s salary is '</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
</code></pre></div><p><strong>all</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> empno<span class="token punctuation">,</span>ename<span class="token punctuation">,</span>sal <span class="token keyword">from</span> emp <span class="token keyword">where</span> sal <span class="token operator">&lt;&gt;</span> <span class="token keyword">all</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token number">950</span><span class="token punctuation">,</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>转义符</strong></p> <p>在like时，会用到%做多个字符的通配符或者_做单个字符的通配符。
如第一个字符是S，第三个字符是L，第五个字符为S</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> empno<span class="token punctuation">,</span>ename<span class="token punctuation">,</span>job <span class="token keyword">from</span> emp <span class="token keyword">where</span> job <span class="token operator">like</span> <span class="token string">'S_L_S%'</span><span class="token punctuation">;</span>
</code></pre></div><p>但是如果字符串含有%或者_，则需使用escape关键字</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept_temp <span class="token keyword">where</span> dname <span class="token operator">like</span> <span class="token string">'IT\_%'</span> <span class="token keyword">escape</span> '\'<span class="token punctuation">;</span>
</code></pre></div><p>在上述查询语句中使用了“\”​。​“\”为转义字符，即在“\”之后的“<em>”字符已不是通配符，而是它本来的含义，即下画线。因此，该查询的结果为：前两个字符为IT，第三个字符为“</em>”​，后跟任意字符的字符串。</p> <p>或者使用别的字符作为转义符，下面语句和上面效果一样。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dept_temp <span class="token keyword">where</span> dname <span class="token operator">like</span> <span class="token string">'ITa_%'</span> <span class="token keyword">escape</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>分组</strong></p> <p>只能用分组列以及聚合函数作为查询投影。
如果在一个查询中使用了分组函数，则任何不在分组函数中的列或表达式必须在GROUPBY子句中。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> columns_list
<span class="token keyword">FROM</span> table_name
<span class="token punctuation">[</span><span class="token keyword">WHERE</span> conditional_expression<span class="token punctuation">]</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> columns_list
</code></pre></div><blockquote><p>在SELECT子句的后面只可以有两类表达式，即统计函数和进行分组的列名。 SELECT子句中的列名必须是进行分组的列，除此之外，添加其他的列名都是错误的，但是GROUP BY子句后面的列名可以不出现在SELECT子句中。 在默认情况下，将按照GROUP BY子句指定的分组列升序排列，如果需要重新排序，可以使用ORDER BY子句指定新的排列顺序</p></blockquote> <p>多列分组：每个部门每种岗位的平均工资和最高工资</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> deptno<span class="token punctuation">,</span>job<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span>
  <span class="token keyword">from</span> emp
  <span class="token keyword">group</span> <span class="token keyword">by</span> deptno<span class="token punctuation">,</span>job<span class="token punctuation">;</span>
</code></pre></div><p><strong>having</strong></p> <blockquote><p>HAVING子句通常与GROUP BY子句一起使用，在完成对分组结果统计后，可以使用HAVING子句对分组的结果做进一步的筛选。</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment"># 此处用where会报错，除非再包一层。where中不可以使用聚集函数。</span>
<span class="token keyword">select</span> deptno<span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> emp <span class="token keyword">group</span> <span class="token keyword">by</span> deptno <span class="token keyword">having</span> <span class="token function">max</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3000</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>小计、总计</strong></p> <blockquote><p>rollup</p></blockquote> <p>会生成横向的小计和总计</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> deptno<span class="token punctuation">,</span>job<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> emp <span class="token keyword">group</span> <span class="token keyword">by</span> rollup<span class="token punctuation">(</span>deptno<span class="token punctuation">,</span>job<span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> deptno<span class="token punctuation">;</span>
</code></pre></div><blockquote><p>cube</p></blockquote> <p>除横向小计和总计外，另会生成竖向小计，如上面rollup除部门岗位的分组维度外，另会生成部门维度的小计。
但是cube除了部门岗位的分组维度外，他还会生成部门维度的横向小计以及岗位维度的竖向小计。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> deptno<span class="token punctuation">,</span>job<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> emp <span class="token keyword">group</span> <span class="token keyword">by</span> cube<span class="token punctuation">(</span>deptno<span class="token punctuation">,</span>job<span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> deptno<span class="token punctuation">;</span>
</code></pre></div><p>在使用rollup和cube时，可以使用grouping来判断多生成的结果是否使用到了某个列。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> deptno<span class="token punctuation">,</span>job<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span><span class="token punctuation">,</span>grouping<span class="token punctuation">(</span>deptno<span class="token punctuation">)</span><span class="token punctuation">,</span>grouping<span class="token punctuation">(</span>job<span class="token punctuation">)</span> <span class="token keyword">from</span> emp <span class="token keyword">group</span> <span class="token keyword">by</span> cube<span class="token punctuation">(</span>deptno<span class="token punctuation">,</span>job<span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> deptno<span class="token punctuation">;</span>
</code></pre></div><p><img src="/assets/img/oracle6.6afd1e88.png" alt=""></p> <blockquote><p>过滤部分小计。如只想要总计和部门岗位的统计。他也是按类似最左匹配。如group by(a,b,c)和group by(a, (b, c))是不同的结果，前者会生成(a,b,c)和(a,b)、(a)、()的分组结果。但是后者为(a,b,c)、(a)、()的分组结果。如下面查询，只会按部门岗位group by以及总计。dept维度的小计将不会再生成。</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> deptno<span class="token punctuation">,</span>job<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> emp <span class="token keyword">group</span> <span class="token keyword">by</span><span class="token punctuation">(</span><span class="token punctuation">(</span>deptno<span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/assets/img/oracle7.5989734b.png" alt=""></p> <blockquote><p>grouping set</p></blockquote> <p>该语法可以生成多个分组统计，并将其合并到一次查询结果。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> deptno<span class="token punctuation">,</span>job<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">from</span> emp <span class="token keyword">group</span> <span class="token keyword">by</span> grouping sets<span class="token punctuation">(</span>deptno<span class="token punctuation">,</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>    DEPTNO <span class="token environment constant">JOB</span>                  AVG<span class="token punctuation">(</span>SAL<span class="token punctuation">)</span>
---------- ------------------ ----------
           CLERK                  <span class="token number">1037.5</span>
           SALESMAN                 <span class="token number">1400</span>
           ANALYST                  <span class="token number">3000</span>
           MANAGER            <span class="token number">2758.33333</span>
           PRESIDENT                <span class="token number">5000</span>
        <span class="token number">30</span>                    <span class="token number">1566.66667</span>
        <span class="token number">10</span>                    <span class="token number">2916.66667</span>
        <span class="token number">20</span>                          <span class="token number">2175</span>
</code></pre></div><blockquote><p>order by</p></blockquote> <p>在使用order by时，若排序字段过长或者使用union等操作时，可以直接写下标。
但不鼓励这种写法，仅在字段过长或者特殊情况下可尝试</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> ename<span class="token punctuation">,</span>empno<span class="token punctuation">,</span>sal<span class="token operator">*</span><span class="token number">12</span> Annual_Salary <span class="token keyword">from</span> emp <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">3</span> <span class="token keyword">asc</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>连接</strong></p> <ul><li>内连接</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp e <span class="token punctuation">[</span><span class="token keyword">inner</span><span class="token punctuation">]</span> <span class="token keyword">join</span> dept d <span class="token keyword">on</span> e<span class="token punctuation">.</span>deptno <span class="token operator">=</span> d<span class="token punctuation">.</span>deptno<span class="token punctuation">;</span>
</code></pre></div><ul><li>左外连接</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp e <span class="token keyword">left</span> <span class="token keyword">join</span> dept d <span class="token keyword">on</span> e<span class="token punctuation">.</span>deptno <span class="token operator">=</span> d<span class="token punctuation">.</span>deptno<span class="token punctuation">;</span>
</code></pre></div><ul><li>右外连接</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp e <span class="token keyword">right</span> <span class="token keyword">join</span> dept d <span class="token keyword">on</span> e<span class="token punctuation">.</span>deptno <span class="token operator">=</span> d<span class="token punctuation">.</span>deptno<span class="token punctuation">;</span>
</code></pre></div><ul><li>全外连接</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp e <span class="token keyword">full</span> <span class="token keyword">join</span> dept d <span class="token keyword">on</span> e<span class="token punctuation">.</span>deptno <span class="token operator">=</span> d<span class="token punctuation">.</span>deptno<span class="token punctuation">;</span>
</code></pre></div><p>区别为内连接为包含两边都满足on条件的数据（14条）
左外连接出了满足on条件的数据外，还包含左边不满足on的数据。（无部门的员工会被查出）
右连接同理，包含右边不满足on的数据。（无员工的部门会被查出）
全外连接则将两种不满足条件的数据都查出。</p> <ul><li>自连接</li></ul> <p>如想查出员工表信息及其上级信息，则可以使用自连接</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp e1 <span class="token keyword">left</span> <span class="token keyword">join</span> emp e2 <span class="token keyword">on</span> e1<span class="token punctuation">.</span>mgr <span class="token operator">=</span> e2<span class="token punctuation">.</span>empno<span class="token punctuation">;</span>
</code></pre></div><p><strong>系统函数</strong></p> <ul><li>ascii</li> <li>chr</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> ascii<span class="token punctuation">(</span><span class="token string">'H'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>chr<span class="token punctuation">(</span><span class="token string">'72'</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
</code></pre></div><ul><li>concat
字符串连接</li> <li>initcap
首字母大写</li> <li>instr(s1,s2[,i][,j])
从第i个字符起查询s2在s1中第j次出现</li> <li>length(s)</li> <li>replace(s1,s2[,s3])
使用s3替换s1中的s2</li> <li>substr(s1,i[,j])
从第i个位置截取长度为j的字符串</li> <li>round(n1[,n2])
舍弃n1的小数点右边位数</li> <li>power</li> <li>sysdate</li> <li>add_months(sysdate,n1)</li> <li>to_char(sysdate,'YYYY-MM-DD')</li></ul> <p><strong>子查询</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> empno<span class="token punctuation">,</span>ename<span class="token punctuation">,</span>job <span class="token keyword">from</span> emp <span class="token keyword">where</span> deptno<span class="token operator">=</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> deptno <span class="token keyword">from</span> dept <span class="token keyword">where</span> dname<span class="token operator">=</span><span class="token string">'RESEARCH'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>查询非10号部门工资高于10号某个员工工资的员工</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> deptno<span class="token punctuation">,</span>ename<span class="token punctuation">,</span>sal <span class="token keyword">from</span> emp <span class="token keyword">where</span> sal <span class="token operator">&gt;</span> <span class="token keyword">any</span>
 <span class="token punctuation">(</span><span class="token keyword">select</span> sal <span class="token keyword">from</span> emp <span class="token keyword">where</span> deptno <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">and</span> deptno <span class="token operator">&lt;&gt;</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre></div><p>查询工资比30号部门所有员工工资都高的员工</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> deptno<span class="token punctuation">,</span>ename<span class="token punctuation">,</span>sal <span class="token keyword">from</span> emp <span class="token keyword">where</span> sal <span class="token operator">&gt;</span> <span class="token keyword">all</span>
 <span class="token punctuation">(</span><span class="token keyword">select</span> sal <span class="token keyword">from</span> emp <span class="token keyword">where</span> deptno <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_4-pl-sql"><a href="#_4-pl-sql" class="header-anchor">#</a> 4.PL/SQL</h2> <p>语法</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token punctuation">[</span><span class="token keyword">DECLARE</span><span class="token punctuation">]</span>
<span class="token comment">--声明部分，可选</span>
<span class="token keyword">BEGIN</span>
<span class="token comment">--执行部分，必需</span>
<span class="token punctuation">[</span>EXCEPTION<span class="token punctuation">]</span>
<span class="token comment">--异常处理部分，可选</span>
<span class="token keyword">END</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">set</span> serveroutput <span class="token keyword">on</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">declare</span>
  <span class="token number">2</span>    a <span class="token keyword">int</span>:<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span>
  <span class="token number">3</span>    b <span class="token keyword">int</span>:<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">;</span>
  <span class="token number">4</span>    c number<span class="token punctuation">;</span>
  <span class="token number">5</span>  <span class="token keyword">begin</span>
  <span class="token number">6</span>    c:<span class="token operator">=</span><span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>a<span class="token operator">-</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">7</span>    dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">8</span>  exception
  <span class="token number">9</span>    <span class="token keyword">when</span> zero_divide <span class="token keyword">then</span>
  <span class="token number">10</span>    dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'除数不许为零!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">11</span>  <span class="token keyword">end</span><span class="token punctuation">;</span>
  <span class="token number">12</span>  <span class="token operator">/</span>
</code></pre></div><h3 id="_4-1-数据类型"><a href="#_4-1-数据类型" class="header-anchor">#</a> 4.1 数据类型</h3> <h4 id="_4-1-1-基本类型"><a href="#_4-1-1-基本类型" class="header-anchor">#</a> 4.1.1 基本类型</h4> <blockquote><p>数值</p></blockquote> <ul><li>number
整数或浮点数。number(p,s) p为精度，所有有效数字个数，s为刻度范围，小数点右边小数位的个数。</li> <li>binary_integer</li> <li>pls_integer</li></ul> <blockquote><p>字符</p></blockquote> <ul><li><p>varchar2
可变长度字符串，最大长度32762，而数据库中最大长度为4000，因此pl/sql中的varchar2不可赋值于pl/sql中的varchar2，而只能赋值给LONG类型变量。</p></li> <li><p>LONG
表示可变字符串，最大长度32762,数据库中LONG最多有2GB，所以所有的字符串变量都可赋值给它。</p></li> <li><p>char
固定长度，不足会以空格补齐。默认长度为1。</p></li> <li><p>NCHAR</p></li> <li><p>NVARCHAR2
pl/sql 8.0之后引入的类型，根据各国字符集确定长度。</p></li></ul> <blockquote><p>日期类型</p></blockquote> <ul><li>date
七个字节，世纪、年、月、日、天、小时、分钟、秒</li></ul> <blockquote><p>布尔类型</p></blockquote> <h4 id="_4-1-2-特殊类型"><a href="#_4-1-2-特殊类型" class="header-anchor">#</a> 4.1.2 特殊类型</h4> <blockquote><p>%TYPE
声明与指定列相同的数据类型</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">declare</span>
var_job emp<span class="token punctuation">.</span>job<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>record
类似class,将多个列组成一条记录。</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">declare</span>
  <span class="token keyword">type</span> emp_record <span class="token operator">is</span> record
  <span class="token punctuation">(</span>
    var_name varchar2<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    var_job varchar2<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    var_sal number
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  empinfo emp_record<span class="token punctuation">;</span>
<span class="token keyword">begin</span>
  <span class="token keyword">select</span> ename<span class="token punctuation">,</span>job<span class="token punctuation">,</span>sal <span class="token keyword">into</span> empinfo <span class="token keyword">from</span> emp <span class="token keyword">where</span> empno <span class="token operator">=</span> <span class="token number">7369</span><span class="token punctuation">;</span>
  dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'ename:'</span> <span class="token operator">||</span> empinfo<span class="token punctuation">.</span>var_name <span class="token operator">||</span> <span class="token string">' ,job:'</span> <span class="token operator">||</span> empinfo<span class="token punctuation">.</span>var_job<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre></div><blockquote><p>%rowtype
直接一行数据的变量名。</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">declare</span>
  emp_row emp<span class="token operator">%</span>rowtype<span class="token punctuation">;</span>
<span class="token keyword">begin</span>
  <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">into</span> emp_row <span class="token keyword">from</span> emp <span class="token keyword">where</span> empno <span class="token operator">=</span> <span class="token number">7369</span><span class="token punctuation">;</span>
  dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'ename:'</span> <span class="token operator">||</span> emp_row<span class="token punctuation">.</span>ename <span class="token operator">||</span> <span class="token string">' ,job:'</span> <span class="token operator">||</span> emp_row<span class="token punctuation">.</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>  
</code></pre></div><h3 id="_4-2-语法"><a href="#_4-2-语法" class="header-anchor">#</a> 4.2 语法</h3> <blockquote><p>if判断</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">IF</span> <span class="token operator">&lt;</span> condition_expression1 <span class="token operator">&gt;</span> <span class="token keyword">THEN</span>
plsql_sentence_1<span class="token punctuation">;</span>
ELSIF <span class="token operator">&lt;</span> condition_expression2 <span class="token operator">&gt;</span> <span class="token keyword">THEN</span>
plsql_sentence_2<span class="token punctuation">;</span>
…
<span class="token keyword">ELSE</span>
plsql_sentence_n<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>case判断</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CASE</span> <span class="token operator">&lt;</span> selector<span class="token operator">&gt;</span>
<span class="token keyword">WHEN</span> <span class="token operator">&lt;</span>expression_1<span class="token operator">&gt;</span> <span class="token keyword">THEN</span> plsql_sentence_1<span class="token punctuation">;</span>
<span class="token keyword">WHEN</span> <span class="token operator">&lt;</span>expression_2<span class="token operator">&gt;</span> <span class="token keyword">THEN</span> plsql_sentence_2<span class="token punctuation">;</span>
…
<span class="token keyword">WHEN</span> <span class="token operator">&lt;</span>expression_n<span class="token operator">&gt;</span> <span class="token keyword">THEN</span> plsql_sentence_n<span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token keyword">ELSE</span> plsql_sentence<span class="token punctuation">;</span><span class="token punctuation">]</span>
<span class="token keyword">END</span> <span class="token keyword">CASE</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>loop循环</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">LOOP</span>
  plsql_sentence<span class="token punctuation">;</span>
<span class="token keyword">EXIT</span> <span class="token keyword">WHEN</span> end_condition_ exp
<span class="token keyword">END</span> <span class="token keyword">LOOP</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">set</span> serveroutput <span class="token keyword">on</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">declare</span>
  <span class="token number">2</span>    sum_i <span class="token keyword">int</span>:<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment">--定义整数变量，存储整数和</span>
  <span class="token number">3</span>    i <span class="token keyword">int</span>:<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>         <span class="token comment">--定义整数变量，存储自然数</span>
  <span class="token number">4</span>  <span class="token keyword">begin</span>
  <span class="token number">5</span>    <span class="token keyword">loop</span>               <span class="token comment">--循环累加自然数</span>
  <span class="token number">6</span>      i:<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                                              <span class="token comment">--得出自然数</span>
  <span class="token number">7</span>      sum_i:<span class="token operator">=</span> sum_i<span class="token operator">+</span>i<span class="token punctuation">;</span>                                     <span class="token comment">--计算前n个自然数的和</span>
  <span class="token number">8</span>      <span class="token keyword">exit</span> <span class="token keyword">when</span> i <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>                                   <span class="token comment">--当循环100次时，程序退出循环体</span>
  <span class="token number">9</span>    <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
  <span class="token number">10</span>   dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'前100个自然数的和是：'</span><span class="token operator">||</span>sum_i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">--计算前100个自然数的和</span>
  <span class="token number">11</span>  <span class="token keyword">end</span><span class="token punctuation">;</span>
  <span class="token number">12</span>  <span class="token operator">/</span>
</code></pre></div><blockquote><p>while循环</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">WHILE</span> condition_expression <span class="token keyword">LOOP</span>
plsql_sentence<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token keyword">LOOP</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">set</span> serveroutput <span class="token keyword">on</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">declare</span>
  <span class="token number">2</span>    sum_i <span class="token keyword">int</span>:<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                         <span class="token comment">--定义整数变量，存储整数和</span>
  <span class="token number">3</span>    i <span class="token keyword">int</span>:<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                             <span class="token comment">--定义整数变量，存储自然数</span>
  <span class="token number">4</span>  <span class="token keyword">begin</span>
  <span class="token number">5</span>    <span class="token keyword">while</span> i<span class="token operator">&lt;=</span><span class="token number">99</span> <span class="token keyword">loop</span>                                       <span class="token comment">--当i的值等于100时，程序退出WHILE循环</span>
  <span class="token number">6</span>      i:<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                                              <span class="token comment">--得出自然数</span>
  <span class="token number">7</span>      sum_i:<span class="token operator">=</span> sum_i<span class="token operator">+</span>i<span class="token punctuation">;</span>                                     <span class="token comment">--计算前n个自然数的和</span>
  <span class="token number">8</span>    <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
  <span class="token number">9</span>    dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'前100个自然数的和是：'</span><span class="token operator">||</span>sum_i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">--计算前100个自然数的和</span>
  <span class="token number">10</span>  <span class="token keyword">end</span><span class="token punctuation">;</span>
  <span class="token number">11</span>  <span class="token operator">/</span>
</code></pre></div><blockquote><p>for循环</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">FOR</span> variable_ counter_name <span class="token operator">in</span> <span class="token punctuation">[</span>REVERSE<span class="token punctuation">]</span> lower_limit<span class="token punctuation">.</span><span class="token punctuation">.</span>upper_limit <span class="token keyword">LOOP</span>
plsql_sentence<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token keyword">LOOP</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">set</span> serveroutput <span class="token keyword">on</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">declare</span>
  <span class="token number">2</span>    sum_i <span class="token keyword">int</span>:<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                     <span class="token comment">--定义整数变量，存储整数和</span>
  <span class="token number">3</span>  <span class="token keyword">begin</span>
  <span class="token number">4</span>    <span class="token keyword">for</span> i <span class="token operator">in</span> reverse <span class="token number">1.</span><span class="token number">.100</span> <span class="token keyword">loop</span>                       <span class="token comment">--遍历前100个自然数</span>
  <span class="token number">5</span>      <span class="token keyword">if</span> <span class="token function">mod</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">then</span>                               <span class="token comment">--判断是否为偶数</span>
  <span class="token number">6</span>        sum_i:<span class="token operator">=</span>sum_i<span class="token operator">+</span>i<span class="token punctuation">;</span>                                <span class="token comment">--计算偶数和</span>
  <span class="token number">7</span>      <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
  <span class="token number">8</span>    <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
  <span class="token number">9</span>    dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'前100个自然数中偶数之和是：'</span><span class="token operator">||</span>sum_i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">10</span>  <span class="token keyword">end</span><span class="token punctuation">;</span>
  <span class="token number">11</span>  <span class="token operator">/</span>
</code></pre></div><blockquote><p>goto语法</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code>… <span class="token comment">--程序其他部分</span>
<span class="token operator">&lt;&lt;</span>goto_mark<span class="token operator">&gt;&gt;</span>         <span class="token comment">--定义了一个转向标签goto_mark</span>
… <span class="token comment">--程序其他部分</span>
<span class="token keyword">IF</span> <span class="token keyword">no</span><span class="token operator">&gt;</span><span class="token number">98050</span> <span class="token keyword">THEN</span>
    <span class="token keyword">GOTO</span> goto_mark<span class="token punctuation">;</span>  <span class="token comment">--如果条件成立，则转向goto_mark继续执行</span>
… <span class="token comment">--程序其他部分</span>
</code></pre></div><h3 id="_4-3-游标"><a href="#_4-3-游标" class="header-anchor">#</a> 4.3 游标</h3> <blockquote><p>显式游标
包括声明、打开、读取（多次）、关闭四个步骤。</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CURSOR</span> cur_name<span class="token punctuation">[</span><span class="token punctuation">(</span>input_parameter1<span class="token punctuation">[</span><span class="token punctuation">,</span>input_parameter2<span class="token punctuation">]</span>…<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">RETURN</span>  ret_type<span class="token punctuation">]</span>
<span class="token operator">IS</span> select_ sentence<span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">set</span> serveroutput <span class="token keyword">on</span><span class="token punctuation">;</span>
<span class="token keyword">declare</span>
    <span class="token keyword">cursor</span> cur_emp <span class="token punctuation">(</span>var_job <span class="token operator">in</span> varchar2:<span class="token operator">=</span><span class="token string">'MANAGER'</span><span class="token punctuation">)</span> <span class="token comment">--定义一个游标，输入参数var_job，类型、初始值。</span>
    <span class="token operator">is</span> <span class="token keyword">select</span> empno<span class="token punctuation">,</span> ename<span class="token punctuation">,</span> sal <span class="token keyword">from</span> emp <span class="token keyword">where</span> job <span class="token operator">=</span> var_job<span class="token punctuation">;</span> <span class="token comment">-- 游标查询语句，提供了结果集</span>
    <span class="token keyword">type</span> emp_record <span class="token operator">is</span> record<span class="token punctuation">(</span>
        var_empno emp<span class="token punctuation">.</span>empno<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">,</span>
        var_ename emp<span class="token punctuation">.</span>ename<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">,</span>
        var_sal emp<span class="token punctuation">.</span>sal<span class="token operator">%</span><span class="token keyword">type</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    emp_row emp_record<span class="token punctuation">;</span>
<span class="token keyword">begin</span>
    <span class="token keyword">open</span> cur_emp<span class="token punctuation">(</span><span class="token string">'MANAGER'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 打开游标，执行select语句，将查询结果装入内存。输入参数可选，如SALESMAN</span>
    <span class="token keyword">fetch</span> cur_emp <span class="token keyword">into</span> emp_row<span class="token punctuation">;</span> <span class="token comment">-- 读取游标</span>
    <span class="token keyword">while</span> cur_emp<span class="token operator">%</span>found <span class="token keyword">loop</span>
        dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span>emp_row<span class="token punctuation">.</span>var_ename <span class="token operator">||</span> <span class="token string">'的编号是：'</span><span class="token operator">||</span> emp_row<span class="token punctuation">.</span>var_empno <span class="token operator">||</span> <span class="token string">',薪水是：'</span> <span class="token operator">||</span> emp_row<span class="token punctuation">.</span>var_sal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">fetch</span> cur_emp <span class="token keyword">into</span> emp_row<span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
    <span class="token keyword">close</span> cur_emp<span class="token punctuation">;</span> <span class="token comment">-- 关闭游标，释放空间</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre></div><p>在使用游标（包括显式和隐式）的FOR循环中，可以声明游标，但不用进行打开游标、读取游标和关闭游标等操作，这些由Oracle系统自动完成。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">set</span> serveroutput <span class="token keyword">on</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">declare</span>
  <span class="token number">2</span>   <span class="token keyword">cursor</span> cur_emp <span class="token operator">is</span>
  <span class="token number">3</span>   <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp
  <span class="token number">4</span>   <span class="token keyword">where</span> deptno <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>                                        <span class="token comment">--检索部门编号为30的员工信息</span>
  <span class="token number">5</span>  <span class="token keyword">begin</span>
  <span class="token number">6</span>    <span class="token keyword">for</span> emp_record <span class="token operator">in</span> cur_emp                                <span class="token comment">--遍历员工信息</span>
  <span class="token number">7</span>    <span class="token keyword">loop</span>
  <span class="token number">8</span>      dbms_output<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'员工编号：'</span><span class="token operator">||</span>emp_record<span class="token punctuation">.</span>empno<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">--输出员工编号</span>
  <span class="token number">9</span>      dbms_output<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">'；员工名称：'</span><span class="token operator">||</span>emp_record<span class="token punctuation">.</span>ename<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">--输出员工名称</span>
  <span class="token number">10</span>      dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'；员工职务：'</span><span class="token operator">||</span>emp_record<span class="token punctuation">.</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">--输出员工职务</span>
  <span class="token number">11</span>    <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
  <span class="token number">12</span>  <span class="token keyword">end</span><span class="token punctuation">;</span>
  <span class="token number">13</span>  <span class="token operator">/</span>
</code></pre></div><blockquote><p>隐式游标</p></blockquote> <p>隐式游标主要是update、delete的执行结果。总是反应最近一条sql的处理结果。隐式游标由sql%拼上属性。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">set</span> serveroutput <span class="token keyword">on</span><span class="token punctuation">;</span>
<span class="token keyword">declare</span>
<span class="token keyword">begin</span>
    <span class="token keyword">update</span> emp <span class="token keyword">set</span> sal <span class="token operator">=</span> sal <span class="token operator">+</span> <span class="token number">100</span> <span class="token keyword">where</span> job <span class="token operator">=</span> <span class="token string">'SALESMAN'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">sql</span><span class="token operator">%</span>found <span class="token keyword">then</span>
        dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'本次涨薪员工数目为:'</span> <span class="token operator">||</span> <span class="token keyword">sql</span><span class="token operator">%</span><span class="token keyword">rowcount</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'本次无员工涨薪'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre></div><blockquote><p>游标属性</p></blockquote> <ul><li>%found
至少影响了一行数据</li> <li>%notfound</li> <li>%rowcount</li> <li>%isopen</li></ul> <blockquote><p>游标变量</p></blockquote> <h3 id="_4-4-异常"><a href="#_4-4-异常" class="header-anchor">#</a> 4.4 异常</h3> <ul><li>oracle内置异常</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">set</span> serveroutput <span class="token keyword">on</span><span class="token punctuation">;</span>
<span class="token keyword">declare</span>
    var_ename emp<span class="token punctuation">.</span>ename<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">;</span>
    var_sal emp<span class="token punctuation">.</span>sal<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
    <span class="token keyword">select</span> ename<span class="token punctuation">,</span>sal <span class="token keyword">into</span> var_ename<span class="token punctuation">,</span>var_sal <span class="token keyword">from</span> emp <span class="token keyword">where</span> deptno <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">sql</span><span class="token operator">%</span>found <span class="token keyword">then</span>
        dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'ename:'</span><span class="token operator">||</span> var_ename <span class="token operator">||</span> <span class="token string">' salary:'</span> <span class="token operator">||</span> var_sal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
exception
    <span class="token keyword">when</span> too_many_rows <span class="token keyword">then</span>
        dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'记录不止一行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">when</span> no_data_found <span class="token keyword">then</span>
        dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'无数据记录'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre></div><ul><li>自定义异常</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">set</span> serveroutput <span class="token keyword">on</span><span class="token punctuation">;</span>
<span class="token keyword">declare</span>
    primary_itrant exception<span class="token punctuation">;</span>
    pragma exception_init<span class="token punctuation">(</span>primary_itrant<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">00001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
   <span class="token keyword">insert</span> <span class="token keyword">into</span> dept <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">'开发部'</span><span class="token punctuation">,</span><span class="token string">'广州'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exception
    <span class="token keyword">when</span> primary_itrant <span class="token keyword">then</span>
        dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'主键重复'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre></div><p>可以使用raise关键字抛出异常</p> <h3 id="_4-5-过程、函数、触发器、包"><a href="#_4-5-过程、函数、触发器、包" class="header-anchor">#</a> 4.5 过程、函数、触发器、包</h3> <blockquote><p>上述PL/SQL块都是匿名的，其中包含的代码无法保存到Oracle数据库中。但很多时候需要保存PL/SQL块，以便随后可以重复使用。这意味着，PL/SQL块需要一个名称，这样才能调用或者引用它。命名的PL/SQL块可以被独立编译并存储在数据库中，Oracle提供了4种可以存储的PL/SQL块，即过程、函数、触发器和包。</p></blockquote> <h4 id="_4-5-1-存储过程"><a href="#_4-5-1-存储过程" class="header-anchor">#</a> 4.5.1 存储过程</h4> <blockquote><p>存储过程是一种命名的PL/SQL块，它既可以没有参数，也可以有若干个输入、输出参数，甚至可以有多个既作为输入又作为输出的参数，但它通常没有返回值。存储过程被保存在数据库中，它不可以被SQL语句直接执行或调用，只能通过EXECUT命令执行或在PL/SQL块内部被调用。由于存储过程是已经编译好的代码，因此在被调用或引用时，其执行效率非常高。</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token punctuation">[</span><span class="token operator">OR</span> <span class="token keyword">REPLACE</span><span class="token punctuation">]</span> <span class="token keyword">PROCEDURE</span> pro_name <span class="token punctuation">[</span><span class="token punctuation">(</span>parameter1<span class="token punctuation">[</span><span class="token punctuation">,</span>parameter2<span class="token punctuation">]</span>…<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">IS</span><span class="token operator">|</span><span class="token keyword">AS</span>
<span class="token keyword">BEGIN</span>
  plsql_sentences<span class="token punctuation">;</span>
<span class="token punctuation">[</span>EXCEPTION<span class="token punctuation">]</span>
  <span class="token punctuation">[</span>dowith _ sentences<span class="token punctuation">;</span><span class="token punctuation">]</span>
<span class="token keyword">END</span> <span class="token punctuation">[</span>pro_name<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>上述语法中的parameter1是存储过程被调用／执行时用到的参数，而不是存储过程内定义的内部变量，内部变量要在IS|AS关键字后面定义，并使用分号(;)结束。</p> <ul><li>无参数</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">procedure</span> pkd_insert_dept <span class="token operator">is</span>
<span class="token keyword">begin</span>
    <span class="token keyword">insert</span> <span class="token keyword">into</span> dept <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">,</span> <span class="token string">'开发部门'</span><span class="token punctuation">,</span><span class="token string">'广州'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">commit</span><span class="token punctuation">;</span>
exception
    <span class="token keyword">when</span> OTHERS <span class="token keyword">then</span>
        dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'已经创建'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span> pkd_insert_dept<span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre></div><p>调用</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">set</span> serveroutput <span class="token keyword">on</span><span class="token punctuation">;</span>
<span class="token keyword">execute</span> pkd_insert_dept<span class="token punctuation">;</span>

<span class="token comment">-- 或者</span>
<span class="token keyword">declare</span>
<span class="token keyword">set</span> serveroutput <span class="token keyword">on</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
    pkd_insert_dept<span class="token punctuation">;</span>    
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre></div><ul><li>带参数</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">procedure</span> pkd_insert_dept_with_param<span class="token punctuation">(</span>
    deptno <span class="token operator">in</span> number<span class="token punctuation">,</span>
    dname <span class="token operator">in</span> varchar2<span class="token punctuation">,</span>
    loc <span class="token operator">in</span> varchar2<span class="token punctuation">)</span>
<span class="token operator">is</span>
<span class="token keyword">begin</span>
    <span class="token keyword">insert</span> <span class="token keyword">into</span> dept <span class="token keyword">values</span><span class="token punctuation">(</span>deptno<span class="token punctuation">,</span>dname<span class="token punctuation">,</span>loc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">commit</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre></div><p>调用</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 按名称</span>
<span class="token keyword">declare</span>
<span class="token keyword">begin</span>
    pkd_insert_dept_with_param<span class="token punctuation">(</span>dname<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">'采购部'</span><span class="token punctuation">,</span> deptno<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token number">98</span><span class="token punctuation">,</span> loc<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">'合肥'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
<span class="token comment">-- 按顺序</span>
<span class="token keyword">begin</span>
      pkd_insert_dept_with_param<span class="token punctuation">(</span><span class="token number">98</span><span class="token punctuation">,</span><span class="token string">'采购部'</span><span class="token punctuation">,</span><span class="token string">'合肥'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre></div><ul><li>包含输出参数</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">procedure</span> pkd_select_dept<span class="token punctuation">(</span>
    var_deptno <span class="token operator">in</span> number<span class="token punctuation">,</span>
    var_dname <span class="token keyword">out</span> dept<span class="token punctuation">.</span>dname<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">,</span>
    var_loc <span class="token keyword">out</span> dept<span class="token punctuation">.</span>loc<span class="token operator">%</span><span class="token keyword">type</span>
<span class="token punctuation">)</span> <span class="token operator">is</span>
<span class="token keyword">begin</span>
    <span class="token keyword">select</span> dname<span class="token punctuation">,</span>loc <span class="token keyword">into</span> var_dname<span class="token punctuation">,</span>var_loc <span class="token keyword">from</span> dept <span class="token keyword">where</span> deptno <span class="token operator">=</span> var_deptno<span class="token punctuation">;</span>
exception
    <span class="token keyword">when</span> no_data_found <span class="token keyword">then</span>
    dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'无数据'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
</code></pre></div><p>调用</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">declare</span>
    var_dname dept<span class="token punctuation">.</span>dname<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">;</span>
    var_loc dept<span class="token punctuation">.</span>loc<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
    pkd_select_dept<span class="token punctuation">(</span><span class="token number">98</span><span class="token punctuation">,</span>var_dname<span class="token punctuation">,</span>var_loc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'部门名称：'</span> <span class="token operator">||</span> var_dname <span class="token operator">||</span> <span class="token string">'部门地址：'</span> <span class="token operator">||</span> var_loc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre></div><p>使用exec执行需要先定义变量</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SQL</span><span class="token operator">&gt;</span> variable var_dname varchar2<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> variable var_loc varchar2<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">exec</span> select_dept<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span>:var_dname<span class="token punctuation">,</span>:var_loc<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">print</span> var_dname var_loc<span class="token punctuation">;</span>
</code></pre></div><h4 id="_4-5-2-函数"><a href="#_4-5-2-函数" class="header-anchor">#</a> 4.5.2 函数</h4> <blockquote><p>函数一般用于计算和返回一个值，可以将经常需要使用的计算或功能写成一个函数。函数的调用是表达式的一部分，而过程的调用是一条PL/SQL语句</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token punctuation">[</span><span class="token operator">OR</span> <span class="token keyword">REPLACE</span><span class="token punctuation">]</span> <span class="token keyword">FUNCTION</span> fun_name<span class="token punctuation">[</span><span class="token punctuation">(</span>parameter1<span class="token punctuation">[</span><span class="token punctuation">,</span>parameter2<span class="token punctuation">]</span>…<span class="token punctuation">)</span> <span class="token keyword">RETURN</span> data_type <span class="token operator">IS</span>
  <span class="token punctuation">[</span>inner_variable<span class="token punctuation">]</span>
<span class="token keyword">BEGIN</span>
  plsql_ sentence<span class="token punctuation">;</span>
<span class="token punctuation">[</span>EXCEPTION<span class="token punctuation">]</span>
  <span class="token punctuation">[</span>dowith _ sentences<span class="token punctuation">;</span><span class="token punctuation">]</span>
<span class="token keyword">END</span> <span class="token punctuation">[</span>fun_name<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span> func_avg_sal_dept<span class="token punctuation">(</span>
    param_deptno number<span class="token punctuation">,</span>
    param_dname varchar2
<span class="token punctuation">)</span> 
<span class="token keyword">return</span> number 
<span class="token operator">is</span>
    vo_avg_sal number<span class="token punctuation">;</span>
<span class="token keyword">begin</span>
    <span class="token keyword">if</span> param_deptno <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span>
        <span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">into</span> vo_avg_sal <span class="token keyword">from</span> emp <span class="token keyword">where</span> deptno <span class="token operator">=</span> param_deptno<span class="token punctuation">;</span>
    <span class="token keyword">else</span> 
        <span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> <span class="token keyword">into</span> vo_avg_sal <span class="token keyword">from</span> emp e <span class="token keyword">left</span> <span class="token keyword">join</span> dept d <span class="token keyword">on</span> e<span class="token punctuation">.</span>deptno <span class="token operator">=</span> d<span class="token punctuation">.</span>deptno <span class="token keyword">where</span> d<span class="token punctuation">.</span>dname <span class="token operator">=</span> param_dname<span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>vo_avg_sal<span class="token punctuation">)</span><span class="token punctuation">;</span>
exception
    <span class="token keyword">when</span> others <span class="token keyword">then</span>
        dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'出现未知异常'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre></div><p>调用</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">declare</span>
    vo_avg_sal number<span class="token punctuation">;</span>
<span class="token keyword">begin</span>
    vo_avg_sal:<span class="token operator">=</span>func_avg_sal_dept<span class="token punctuation">(</span>param_deptno<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token number">10</span><span class="token punctuation">,</span>param_dname<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'平均工资：'</span><span class="token operator">||</span>vo_avg_sal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre></div><h4 id="_4-5-3-触发器"><a href="#_4-5-3-触发器" class="header-anchor">#</a> 4.5.3 触发器</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token punctuation">[</span><span class="token operator">OR</span> <span class="token keyword">REPLACE</span><span class="token punctuation">]</span> <span class="token keyword">TRIGGER</span> tri_name
  <span class="token punctuation">[</span>BEFORE <span class="token operator">|</span> <span class="token keyword">AFTER</span> <span class="token operator">|</span> INSTEAD <span class="token keyword">OF</span><span class="token punctuation">]</span> tri_event
  <span class="token keyword">ON</span> table_name <span class="token operator">|</span> view_name <span class="token operator">|</span> user_name <span class="token operator">|</span> db_name
  <span class="token punctuation">[</span><span class="token keyword">FOR EACH ROW</span> <span class="token punctuation">[</span><span class="token keyword">WHEN</span> tri_condition<span class="token punctuation">]</span>
<span class="token keyword">BEGIN</span>
plsql_sentences<span class="token punctuation">;</span>
<span class="token keyword">END</span> tri_name<span class="token punctuation">;</span>
</code></pre></div><h4 id="_4-5-4-程序包"><a href="#_4-5-4-程序包" class="header-anchor">#</a> 4.5.4 程序包</h4> <ul><li>包</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token punctuation">[</span><span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token punctuation">]</span> PACKAGE pack_name <span class="token operator">IS</span>
<span class="token punctuation">[</span>declare_variable<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>declare_type<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>declare_cursor<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>declare_function<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>declare_ <span class="token keyword">procedure</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token punctuation">[</span>pack_name<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>包主体</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token punctuation">[</span><span class="token operator">OR</span> <span class="token keyword">REPLACE</span><span class="token punctuation">]</span> PACKAGE BODY pack_name <span class="token operator">IS</span>
  <span class="token punctuation">[</span>inner_variable<span class="token punctuation">]</span>
  <span class="token punctuation">[</span>cursor_body<span class="token punctuation">]</span>
  <span class="token punctuation">[</span>function_title<span class="token punctuation">]</span>
  {<span class="token keyword">BEGIN</span>
    fun_plsql<span class="token punctuation">;</span>
  <span class="token punctuation">[</span>EXCEPTION<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>dowith _ sentences<span class="token punctuation">;</span><span class="token punctuation">]</span>
  <span class="token keyword">END</span> <span class="token punctuation">[</span>fun_name<span class="token punctuation">]</span>}
  <span class="token punctuation">[</span>procedure_title<span class="token punctuation">]</span>
  {<span class="token keyword">BEGIN</span>
    pro_plsql<span class="token punctuation">;</span>
  <span class="token punctuation">[</span>EXCEPTION<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>dowith _ sentences<span class="token punctuation">;</span><span class="token punctuation">]</span>
  <span class="token keyword">END</span> <span class="token punctuation">[</span>pro_name<span class="token punctuation">]</span>}
…
<span class="token keyword">END</span> <span class="token punctuation">[</span>pack_name<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> package pkg_dept <span class="token operator">is</span>
<span class="token keyword">function</span> func_get_deptname<span class="token punctuation">(</span>param_deptno number<span class="token punctuation">)</span> <span class="token keyword">return</span> varchar2<span class="token punctuation">;</span>
<span class="token keyword">procedure</span> pkd_insert_dept<span class="token punctuation">(</span>param_deptno number<span class="token punctuation">,</span>param_deptname varchar2<span class="token punctuation">,</span>param_loc varchar2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span> pkg_dept<span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> package body pkg_dept <span class="token operator">is</span>
    <span class="token keyword">function</span> func_get_deptname<span class="token punctuation">(</span>param_deptno number<span class="token punctuation">)</span> <span class="token keyword">return</span> varchar2 <span class="token operator">is</span>
        vo_deptname dept<span class="token punctuation">.</span>dname<span class="token operator">%</span><span class="token keyword">type</span><span class="token punctuation">;</span>
    <span class="token keyword">begin</span>
        <span class="token keyword">select</span> dname <span class="token keyword">into</span> vo_deptname <span class="token keyword">from</span> dept <span class="token keyword">where</span> deptno<span class="token operator">=</span>param_deptno<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>vo_deptname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    exception
        <span class="token keyword">when</span> others <span class="token keyword">then</span>
        dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'无该部门'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span> func_get_deptname<span class="token punctuation">;</span>

    <span class="token keyword">procedure</span> pkd_insert_dept<span class="token punctuation">(</span>param_deptno number<span class="token punctuation">,</span>param_deptname varchar2<span class="token punctuation">,</span>param_loc varchar2<span class="token punctuation">)</span> <span class="token operator">is</span>
    <span class="token keyword">begin</span>
        <span class="token keyword">insert</span> <span class="token keyword">into</span> dept <span class="token keyword">values</span><span class="token punctuation">(</span>param_deptno<span class="token punctuation">,</span>param_deptname<span class="token punctuation">,</span>param_loc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    exception
        <span class="token keyword">when</span> others <span class="token keyword">then</span>
        dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span><span class="token string">'新增部门错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span> pkd_insert_dept<span class="token punctuation">;</span>
<span class="token keyword">end</span> pkg_dept<span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/backend/ssm.html" class="prev">
        SSM项目
      </a></span> <span class="next"><a href="/yunwei/vmware.html">
        VMware
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1211b944.js" defer></script><script src="/assets/js/2.d9cdd38b.js" defer></script><script src="/assets/js/4.642422bc.js" defer></script>
  </body>
</html>
